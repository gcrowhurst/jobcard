<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motor Vehicle Job Card</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f2f2f7;
            min-height: 100vh;
            padding: 0;
            line-height: 1.5;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #f2f2f7;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            color: white;
            padding: 20px 20px 30px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 13px;
            opacity: 0.85;
            font-weight: 400;
        }

        .form-content {
            padding: 16px;
        }

        .section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 17px;
            color: #1c1c1e;
            margin-bottom: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            letter-spacing: -0.3px;
        }

        .section-title::before {
            display: none;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #3c3c43;
            margin-bottom: 8px;
            letter-spacing: -0.1px;
        }

        input[type="text"],
        input[type="date"],
        input[type="file"],
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d1d6;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s;
            font-family: inherit;
            background: white;
            color: #1c1c1e;
            -webkit-appearance: none;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            letter-spacing: -0.2px;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-small {
            padding: 10px 16px;
            font-size: 14px;
            border-radius: 10px;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-primary:hover {
            background: #0051D5;
        }

        .btn-secondary {
            background: #8E8E93;
            color: white;
        }

        .btn-secondary:hover {
            background: #636366;
        }

        .btn-success {
            background: #34C759;
            color: white;
        }

        .btn-success:hover {
            background: #30B350;
        }

        .btn-danger {
            background: #FF3B30;
            color: white;
        }

        .btn-danger:hover {
            background: #D70015;
        }

        .btn-info {
            background: #5AC8FA;
            color: white;
        }

        .btn-info:hover {
            background: #32ADE6;
        }

        .status-message {
            padding: 14px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            display: none;
            animation: slideIn 0.3s ease;
            font-size: 14px;
        }
        

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-message.success {
            background: #D1F2EB;
            color: #0C5134;
            border: none;
        }

        .status-message.error {
            background: #FFEBE9;
            color: #8B0000;
            border: none;
        }

        .info-box {
            background: #F0F0F5;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            color: #3c3c43;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 16px;
            background: white;
            border-bottom: 1px solid #E5E5EA;
        }

        .tab {
            flex: 0 0 auto;
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid #E5E5EA;
            background: #F9F9FB;
            color: #1c1c1e;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #F0F0F5;
        }

        .tab.active {
            background: #007AFF;
            color: white;
            border-color: #007AFF;
        }

        /* Tab panels: hide by default, show active */
        .section[data-tab] { display: none; }
        .section[data-tab].active { display: block; }

        /* Customer Requests Section */
        .request-item {
            background: #F9F9FB;
            padding: 14px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid #E5E5EA;
        }

        .request-item.completed {
            background: #E8F5E9;
            border-color: #C8E6C9;
            opacity: 0.7;
        }

        .request-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            flex-shrink: 0;
            accent-color: #007AFF;
        }

        .request-item .request-text {
            flex: 1;
            font-size: 15px;
            color: #1c1c1e;
        }

        .request-item.completed .request-text {
            text-decoration: line-through;
            color: #8E8E93;
        }

        .request-item .delete-btn {
            padding: 6px 12px;
            background: #FF3B30;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            flex-shrink: 0;
            font-weight: 600;
        }

        .request-item .delete-btn:hover {
            background: #D70015;
        }

        .add-request-input, .add-task-input {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            margin-bottom: 12px;
        }

        /* Jobs Section */
        .job-card {
            background: white;
            border: 1px solid #007AFF;
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.08);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 14px;
            padding-bottom: 14px;
            border-bottom: 1px solid #E5E5EA;
        }

        .job-title {
            flex: 1;
        }

        .job-number {
            font-size: 11px;
            color: #8E8E93;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .job-request {
            font-size: 15px;
            color: #1c1c1e;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: -0.2px;
        }

        .job-status {
            font-size: 11px;
            padding: 5px 10px;
            border-radius: 10px;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .job-status.completed {
            background: #D1F2EB;
            color: #0C5134;
        }

        .job-status.in-progress {
            background: #FFF4CE;
            color: #996A00;
        }

        .job-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        /* Tasks within Jobs */
        .task-item {
            background: #F9F9FB;
            border-left: 3px solid #34C759;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 10px;
        }

        .task-header {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .task-header input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-top: 2px;
            flex-shrink: 0;
            accent-color: #34C759;
        }

        .task-description {
            flex: 1;
            font-size: 14px;
            color: #1c1c1e;
            font-weight: 500;
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-item.completed .task-description {
            text-decoration: line-through;
            color: #8E8E93;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-left: 30px;
            margin-top: 8px;
        }

        .photo-section {
            margin-left: 30px;
            margin-top: 8px;
        }

        .photo-upload-label {
            display: inline-block;
            padding: 8px 14px;
            background: #007AFF;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .photo-upload-label:hover {
            background: #0056D6;
        }

        .photo-upload-label input[type="file"] {
            display: none;
        }

        .photo-grid, .task-photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .photo-item, .task-photo-container {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            background: #f0f0f5;
        }

        .photo-item img, .task-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .delete-photo-btn, .task-photo-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 59, 48, 0.95);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        .photo-item .delete-photo-btn:hover, .task-photo-remove:hover {
            background: #FF3B30;
        }

        /* Tools Section */
        .tool-item {
            background: #F9F9FB;
            padding: 12px 14px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #E5E5EA;
        }

        .tool-info {
            flex: 1;
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 15px;
            color: #1c1c1e;
        }

        .tool-item .delete-btn {
            padding: 6px 12px;
            background: #FF3B30;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .tool-item .delete-btn:hover {
            background: #D70015;
        }

        /* Main Photo Gallery */
        #photoGallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .photo-container {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            background: #f0f0f5;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .photo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-container .remove-photo {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 59, 48, 0.95);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
        }

        .photo-container .remove-photo:hover {
            background: #FF3B30;
            transform: scale(1.1);
        }

        /* Signature Canvas */
        #signatureCanvas {
            border: 2px solid #E5E5EA;
            border-radius: 12px;
            cursor: crosshair;
            touch-action: none;
            background: white;
            width: 100%;
            max-width: 600px;
            display: block;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8E8E93;
            font-size: 15px;
            background: #F9F9FB;
            border-radius: 12px;
            margin: 16px 0;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.6;
        }

        .empty-state-text {
            font-size: 15px;
            color: #8E8E93;
            line-height: 1.4;
        }

        /* Bottom Actions */
        .bottom-actions {
            position: sticky;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 16px 20px;
            margin: 20px -20px -20px -20px;
            border-top: 1px solid #E5E5EA;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        /* Loading States */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .loading.active {
            display: flex;
        }

        .spinner, .loading-indicator {
            width: 40px;
            height: 40px;
            border: 3px solid #E5E5EA;
            border-top-color: #007AFF;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .add-task-section {
            background: #F9F9FB;
            padding: 14px;
            border-radius: 12px;
            margin-top: 12px;
            border: 1px solid #E5E5EA;
        }

        /* Responsive Design */
        @media (max-width: 640px) {
            .container {
                padding: 0;
                border-radius: 0;
                margin: 0;
                min-height: 100vh;
            }

            .header {
                border-radius: 0;
                padding: 16px 20px;
            }

            .section {
                border-radius: 0;
                margin-bottom: 8px;
            }

            h1 {
                font-size: 24px;
            }

            .section-title {
                font-size: 18px;
            }

            .job-card {
                border-radius: 12px;
            }

            #photoGallery {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 8px;
            }

            .bottom-actions {
                display: none;
            }
        }

        @media (max-width: 375px) {
            .header {
                padding: 14px 16px;
            }

            h1 {
                font-size: 22px;
            }

            .section {
                padding: 16px;
            }

            .section-title {
                font-size: 17px;
            }

            input, select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
            }

            #photoGallery, .task-photo-gallery, .photo-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üöó Motor Vehicle Job Card</h1>
            <p>Document your work and evidence</p>
        </div>

        <div class="tabs" id="tabs">
            <button class="tab" data-tab-target="template">Template</button>
            <button class="tab" data-tab-target="student">Student</button>
            <button class="tab" data-tab-target="photos">Photos</button>
            <button class="tab" data-tab-target="vehicle">Vehicle</button>
            <button class="tab" data-tab-target="requests">Requests</button>
            <button class="tab" data-tab-target="jobs">Jobs</button>
            <button class="tab" data-tab-target="methodology">Methodology</button>
            <button class="tab" data-tab-target="tools">Tools</button>
            <button class="tab" data-tab-target="data">Data</button>
            <button class="tab" data-tab-target="reflection">Reflection</button>
            <button class="tab" data-tab-target="cards">Cards</button>
            <button class="tab" data-tab-target="signature">Signature</button>
            <button class="tab" data-tab-target="actions">Actions</button>
        </div>

        <div class="form-content">
            <div class="status-message" id="statusMessage"></div>

            <!-- Template Selection -->
            <div class="section" data-tab="template">
                <h2 class="section-title">üìã Load Assessment Template</h2>
                <div class="info-box">
                    Select a template to load predefined requests and tools
                </div>
                <div class="form-group">
                    <label for="templateSelect">Choose Template</label>
                    <select id="templateSelect" onchange="loadTemplate()">
                        <option value="">-- Select a template --</option>
                    </select>
                    <small style="display: block; margin-top: 5px; color: #666;">Loading templates from json-templates/ folder...</small>
                </div>
            </div>

            <!-- Student Information -->
            <div class="section" data-tab="student">
                <h2 class="section-title">Student Information</h2>
                <div class="two-column">
                    <div class="form-group">
                        <label for="studentName">Student Name</label>
                        <input type="text" id="studentName" placeholder="Enter your name">
                    </div>
                    <div class="form-group">
                        <label for="jobDate">Date</label>
                        <input type="date" id="jobDate">
                    </div>
                </div>
                <div class="form-group">
                    <label for="jobLocation">Location / Workshop</label>
                    <input type="text" id="jobLocation" placeholder="e.g., College Workshop">
                </div>
            </div>

            <!-- Photos Section -->
            <div class="section" data-tab="photos">
                <h2 class="section-title">üì∑ Photos</h2>
                <div class="form-group">
                    <label for="photoInput">Capture or Upload Photos</label>
                    <input type="file" id="photoInput" accept="image/*" multiple onchange="handlePhotoUpload(event)">
                    <small style="display: block; margin-top: 5px; color: #666;">Photos will be compressed and stored with your job card</small>
                </div>
                <div id="photoGallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 15px;"></div>
            </div>

            <!-- Vehicle Details -->
            <div class="section" data-tab="vehicle">
                <h2 class="section-title">üöó Vehicle Details</h2>
                <div class="two-column">
                    <div class="form-group">
                        <label for="vehicleReg">Registration Number</label>
                        <input type="text" id="vehicleReg" placeholder="e.g., AB21XYZ">
                    </div>
                    <div class="form-group">
                        <label for="vehicleMake">Make & Model</label>
                        <input type="text" id="vehicleMake" placeholder="e.g., Ford Focus 1.6">
                    </div>
                </div>
                <div class="two-column">
                    <div class="form-group">
                        <label for="vehicleYear">Year</label>
                        <input type="text" id="vehicleYear" placeholder="e.g., 2020">
                    </div>
                    <div class="form-group">
                        <label for="vehicleOdometer">Odometer Reading (miles)</label>
                        <input type="text" id="vehicleOdometer" placeholder="e.g., 45000">
                    </div>
                </div>
            </div>

            <!-- Customer Requests -->
            <div class="section" data-tab="requests">
                <h2 class="section-title">Customer Requests</h2>
                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    Add each request from the customer. You'll select which request you're working on when adding jobs below.
                </p>
                <div class="add-request-input">
                    <input type="text" id="newRequestInput" placeholder="Add a customer request...">
                    <button class="btn btn-info btn-small" onclick="addCustomerRequest()">+ Add</button>
                </div>
                <div id="requestsList"></div>
            </div>

            <!-- Jobs -->
            <div class="section" data-tab="jobs">
                <h2 class="section-title">My Jobs</h2>
                <div class="form-group">
                    <label for="selectRequest">Select Customer Request to Work On</label>
                    <select id="selectRequest">
                        <option value="">-- Select a customer request first --</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="addJob()" style="margin-bottom: 20px;">+ Start New Job</button>
                <div id="jobsList"></div>
            </div>

            <!-- Methodology Section -->
            <div class="section" data-tab="methodology">
                <h2 class="section-title">üìã Methodology</h2>
                <div class="form-group">
                    <label for="methodology">Select your approach and methods used</label>
                    <select id="methodology">
                        <option value="">-- Select methodology --</option>
                        <option value="visual-inspection">Visual Inspection and Testing</option>
                        <option value="diagnostic-equipment">Diagnostic Equipment Analysis</option>
                        <option value="manufacturer-procedures">Manufacturer Service Procedures</option>
                        <option value="component-replacement">Component Removal and Replacement</option>
                        <option value="system-testing">System Testing and Verification</option>
                        <option value="measurement-recording">Precision Measurement and Recording</option>
                        <option value="fault-diagnosis">Fault Code Analysis and Diagnosis</option>
                        <option value="preventive-maintenance">Preventive Maintenance Procedures</option>
                        <option value="repair-adjustment">Repair and Adjustment Techniques</option>
                        <option value="quality-checks">Quality Checks and Final Inspection</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="methodologyNotes">Additional Notes (Optional)</label>
                    <textarea id="methodologyNotes" placeholder="Add any additional details about your methodology..."></textarea>
                </div>
            </div>

            <!-- Tools & Equipment -->
            <div class="section" data-tab="tools">
                <h2 class="section-title">üîß Tools & Equipment</h2>
                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    Add each tool or piece of equipment used for this job.
                </p>
                <div class="add-request-input">
                    <input type="text" id="newToolInput" placeholder="e.g., Torque wrench, Socket set, Jack...">
                    <button class="btn btn-info btn-small" onclick="addTool()">+ Add</button>
                </div>
                <div id="toolsList"></div>
            </div>

            <!-- Technical Data -->
            <div class="section" data-tab="data">
                <h2 class="section-title">üìä Technical Data</h2>
                <div class="form-group">
                    <label for="technicalData">Record relevant measurements and specifications</label>
                    <textarea id="technicalData" placeholder="e.g., Torque settings: 85 Nm, Fluid capacity: 5L, Temperature: 45¬∞C..."></textarea>
                </div>
            </div>

            <!-- Learner Profile -->
            <div class="section" data-tab="reflection">
                <h2 class="section-title">üéì Learner Reflection</h2>
                <div class="form-group">
                    <label for="learnerProfile">Learner Profile Notes</label>
                    <textarea id="learnerProfile" placeholder="Reflection on what you learned and your progress..."></textarea>
                </div>
            </div>

            <!-- Multiple Job Cards Management -->
            <div class="section" data-tab="cards">
                <h2 class="section-title">üìë Job Cards</h2>
                <div class="two-column">
                    <div class="form-group">
                        <label for="cardName">Job Card Name</label>
                        <input type="text" id="cardName" placeholder="e.g., Engine Repair - Jan 2026">
                    </div>
                    <div class="button-group" style="margin-top: 22px;">
                        <button class="btn btn-info btn-small" onclick="saveAsNewCard()">üíæ Save As New Card</button>
                    </div>
                </div>
                <div id="savedCardsList" style="margin-top: 15px;"></div>
            </div>

            <!-- Learner Signature -->
            <div class="section" data-tab="signature">
                <h2 class="section-title">‚úèÔ∏è Learner Signature</h2>
                <div class="form-group">
                                <!-- Actions Tab (for mobile) -->
                                <div class="section" data-tab="actions">
                                    <h2 class="section-title">‚öôÔ∏è Actions</h2>
                                    <div class="button-group">
                                        <button class="btn btn-primary" onclick="saveJobCard()">üíæ Save Progress</button>
                                        <button class="btn btn-success" onclick="loadJobCard()">üìÇ Load Saved</button>
                                        <button class="btn btn-secondary" onclick="exportToPDF()">üìÑ Export PDF</button>
                                        <button class="btn btn-danger" onclick="clearForm()">üóëÔ∏è Clear All</button>
                                    </div>
                                </div>

                    <label>Sign Below</label>
                    <canvas id="signatureCanvas" width="600" height="150" style="border: 2px solid #e0e0e0; border-radius: 8px; cursor: crosshair; background: white; display: block; margin: 10px 0;"></canvas>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="clearSignature()" style="flex: 1;">Clear Signature</button>
                        <button type="button" class="btn btn-info" onclick="saveSignature()" style="flex: 1;">Save Signature</button>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="bottom-actions">
                <button class="btn btn-primary" onclick="saveJobCard()">üíæ Save Progress</button>
                <button class="btn btn-success" onclick="loadJobCard()">üìÇ Load Saved</button>
                <button class="btn btn-secondary" onclick="exportToPDF()">üìÑ Export PDF</button>
                <button class="btn btn-danger" onclick="clearForm()">üóëÔ∏è Clear All</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        let db;
        let useLocalStorage = false; // Fallback flag
        let currentJobId = 0;
        let currentTaskId = 0;
        let currentToolId = 0;
        const DB_NAME = 'MotorVehicleJobCardDB';
        const STORE_NAME = 'jobCards';
        const PHOTO_STORE = 'photos';
        const STORAGE_KEY = 'jobcard_data';
        
        let customerRequests = [];
        let jobs = [];
        let tools = [];
        let jobCards = [];
        let photos = []; // Store compressed photos
        let signatureImage = null; // Store canvas signature
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // Note: Templates are now loaded from JSON files in json-templates/ folder
        // They are dynamically loaded in loadTemplates() function

        // Initialize IndexedDB with localStorage fallback
        function initDB() {
            return new Promise((resolve) => {
                try {
                    const testDb = indexedDB.open('test');
                    testDb.onerror = () => {
                        console.warn('IndexedDB unavailable, using localStorage');
                        useLocalStorage = true;
                        resolve(null);
                    };
                    testDb.onsuccess = () => {
                        testDb.result.close();
                        const request = indexedDB.open(DB_NAME, 2);
                        request.onerror = () => {
                            console.warn('IndexedDB error, using localStorage');
                            useLocalStorage = true;
                            resolve(null);
                        };
                        request.onsuccess = () => {
                            db = request.result;
                            resolve(db);
                        };
                        request.onupgradeneeded = (event) => {
                            const database = event.target.result;
                            if (!database.objectStoreNames.contains(STORE_NAME)) {
                                database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                            }
                            if (!database.objectStoreNames.contains(PHOTO_STORE)) {
                                database.createObjectStore(PHOTO_STORE, { keyPath: 'id', autoIncrement: true });
                            }
                        };
                    };
                } catch (error) {
                    console.warn('IndexedDB not available:', error);
                    useLocalStorage = true;
                    resolve(null);
                }
            });
        }
        
        // Validate data structure before storing
        function validateFormData(data) {
            if (!data || typeof data !== 'object') return false;
            if (typeof data.studentName !== 'string') return false;
            if (!Array.isArray(data.customerRequests)) return false;
            if (!Array.isArray(data.jobs)) return false;
            if (!Array.isArray(data.tools)) return false;
            return true;
        }

        // Template Management
        // Load templates from json-templates folder
        async function loadTemplates() {
            try {
                const templates = [
                    'json-templates/demo-cooling-systems.json',
                    'json-templates/demo-brake-systems.json'
                ];
                
                const select = document.getElementById('templateSelect');
                
                for (const templatePath of templates) {
                    const response = await fetch(templatePath);
                    if (response.ok) {
                        const data = await response.json();
                        const option = document.createElement('option');
                        option.value = templatePath;
                        option.textContent = data.templateName || templatePath.split('/').pop();
                        select.appendChild(option);
                    }
                }
            } catch (error) {
                console.error('Error loading templates:', error);
            }
        }

        function loadTemplate() {
            const select = document.getElementById('templateSelect');
            const templatePath = select.value;

            // If template deselected (empty value), clear loaded template data
            if (!templatePath) {
                if (customerRequests.length > 0 || tools.length > 0 || jobs.length > 0) {
                    if (confirm('Clear template data (customer requests, tools, and jobs)?')) {
                        customerRequests = [];
                        tools = [];
                        jobs = [];
                        currentJobId = 0;
                        currentTaskId = 0;
                        currentToolId = 0;
                        
                        renderRequests();
                        updateRequestDropdown();
                        renderTools();
                        renderJobs();
                        
                        showMessage('Template data cleared', 'info');
                    }
                }
                return;
            }

            try {
                fetch(templatePath)
                    .then(response => response.json())
                    .then(template => {
                        if (customerRequests.length > 0 || tools.length > 0) {
                            if (!confirm(`Loading template will replace current customer requests and tools. Continue?`)) {
                                select.value = '';
                                return;
                            }
                        }

                        // Load customer requests from template
                        customerRequests = [];
                        if (template.customerRequests && Array.isArray(template.customerRequests)) {
                            template.customerRequests.forEach((text, index) => {
                                customerRequests.push({
                                    id: Date.now() + index,
                                    text: text,
                                    completed: false
                                });
                            });
                        }

                        // Load tools from template
                        tools = [];
                        currentToolId = 0;
                        if (template.tools && Array.isArray(template.tools)) {
                            template.tools.forEach(toolName => {
                                tools.push({
                                    id: ++currentToolId,
                                    name: toolName
                                });
                            });
                        }

                        // Load jobs from template if they exist
                        jobs = [];
                        currentJobId = 0;
                        if (template.jobs && Array.isArray(template.jobs)) {
                            template.jobs.forEach((job, index) => {
                                jobs.push({
                                    id: ++currentJobId,
                                    title: job.title || `Job ${index + 1}`,
                                    description: job.description || '',
                                    tasks: job.tasks || []
                                });
                            });
                        }

                        renderRequests();
                        updateRequestDropdown();
                        renderTools();
                        renderJobs();

                        showMessage(`Template loaded successfully!`, 'success');
                    })
                    .catch(error => {
                        console.error('Error loading template:', error);
                        showMessage('Error loading template', 'error');
                    });
            } catch (error) {
                console.error('Error loading template:', error);
                showMessage('Error loading template', 'error');
            }
        }

        // Image Compression
        async function compressImage(file, maxWidth = 1200, quality = 0.8) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve({
                            dataUrl: canvas.toDataURL('image/jpeg', quality),
                            fileName: file.name,
                            timestamp: new Date().toISOString()
                        });
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Handle photo upload with compression
        async function handlePhotoUpload(event) {
            const files = event.target.files;
            if (!files.length) return;

            showLoading(true);
            try {
                for (let file of files) {
                    const compressed = await compressImage(file);
                    photos.push(compressed);
                }
                displayPhotos();
                showMessage(`${files.length} photo(s) added`, 'success');
            } catch (error) {
                console.error('Error uploading photos:', error);
                showMessage('Error uploading photos', 'error');
            } finally {
                showLoading(false);
                event.target.value = '';
            }
        }

        // Display photos in gallery
        function displayPhotos() {
            const gallery = document.getElementById('photoGallery');
            gallery.innerHTML = photos.map((photo, index) => `
                <div class="photo-container">
                    <img src="${photo.dataUrl}" alt="Photo ${index + 1}">
                    <button type="button" class="remove-photo" onclick="removePhoto(${index})">√ó</button>
                </div>
            `).join('');
        }

        // Remove photo
        function removePhoto(index) {
            photos.splice(index, 1);
            displayPhotos();
            showMessage('Photo removed', 'success');
        }

        // Signature canvas setup
        function setupSignatureCanvas() {
            const canvas = document.getElementById('signatureCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // Mouse events
            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                [lastX, lastY] = [e.offsetX, e.offsetY];
            });

            canvas.addEventListener('mouseup', () => {
                isDrawing = false;
            });

            canvas.addEventListener('mouseleave', () => {
                isDrawing = false;
            });

            // Touch events for mobile
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                isDrawing = true;
                [lastX, lastY] = [touch.clientX - rect.left, touch.clientY - rect.top];
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!isDrawing) return;
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                [lastX, lastY] = [x, y];
            });

            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                isDrawing = false;
            });

            canvas.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                isDrawing = false;
            });
        }

        function clearSignature() {
            const canvas = document.getElementById('signatureCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            signatureImage = null;
            showMessage('Signature cleared', 'info');
        }

        function saveSignature() {
            const canvas = document.getElementById('signatureCanvas');
            if (!canvas) return;
            const canvasData = canvas.toDataURL('image/png');
            signatureImage = canvasData;
            showMessage('Signature saved', 'success');
        }

        async function deletePhoto(photoId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([PHOTO_STORE], 'readwrite');
                const store = transaction.objectStore(PHOTO_STORE);
                const request = store.delete(photoId);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Add customer request
        function addCustomerRequest() {
            const input = document.getElementById('newRequestInput');
            const text = input.value.trim();
            
            if (!text) {
                showMessage('Please enter a customer request', 'error');
                return;
            }

            const request = {
                id: Date.now(),
                text: text,
                completed: false
            };

            customerRequests.push(request);
            input.value = '';
            renderRequests();
            updateRequestDropdown();
            showMessage('Customer request added', 'success');
        }

        function toggleRequestCompletion(id) {
            const request = customerRequests.find(r => r.id === id);
            if (request) {
                request.completed = !request.completed;
                renderRequests();
            }
        }

        function deleteCustomerRequest(id) {
            if (confirm('Delete this customer request? Jobs linked to it will remain.')) {
                customerRequests = customerRequests.filter(r => r.id !== id);
                renderRequests();
                updateRequestDropdown();
                showMessage('Customer request removed', 'success');
            }
        }

        function renderRequests() {
            const requestsList = document.getElementById('requestsList');
            
            if (customerRequests.length === 0) {
                requestsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>No customer requests added yet. Load a template or add manually.</p></div>';
                return;
            }

            requestsList.innerHTML = customerRequests.map(req => `
                <div class="request-item ${req.completed ? 'completed' : ''}">
                    <input type="checkbox" ${req.completed ? 'checked' : ''} onchange="toggleRequestCompletion(${req.id})">
                    <div class="request-text">${escapeHtml(req.text)}</div>
                    <button class="delete-btn" onclick="deleteCustomerRequest(${req.id})">Remove</button>
                </div>
            `).join('');
        }

        function updateRequestDropdown() {
            const select = document.getElementById('selectRequest');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">-- Select a customer request --</option>' +
                customerRequests.map(req => 
                    `<option value="${req.id}">${escapeHtml(req.text)}</option>`
                ).join('');
            
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // Tools Management
        function addTool() {
            const input = document.getElementById('newToolInput');
            const text = input.value.trim();
            
            if (!text) {
                showMessage('Please enter a tool name', 'error');
                return;
            }

            const tool = {
                id: ++currentToolId,
                name: text
            };

            tools.push(tool);
            input.value = '';
            renderTools();
            showMessage('Tool added', 'success');
        }

        function deleteTool(id) {
            tools = tools.filter(t => t.id !== id);
            renderTools();
            showMessage('Tool removed', 'success');
        }

        function renderTools() {
            const toolsList = document.getElementById('toolsList');
            
            if (tools.length === 0) {
                toolsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîß</div><p>No tools added yet. Load a template or add manually.</p></div>';
                return;
            }

            toolsList.innerHTML = tools.map(tool => `
                <div class="tool-item">
                    <div class="tool-name">${escapeHtml(tool.name)}</div>
                    <button class="delete-btn" onclick="deleteTool(${tool.id})">Remove</button>
                </div>
            `).join('');
        }

        // Add job
        function addJob() {
            const requestId = document.getElementById('selectRequest').value;
            
            if (!requestId) {
                showMessage('Please select a customer request first', 'error');
                return;
            }

            const request = customerRequests.find(r => r.id == requestId);
            if (!request) {
                showMessage('Selected request not found', 'error');
                return;
            }

            const job = {
                id: ++currentJobId,
                requestId: parseInt(requestId),
                requestText: request.text,
                tasks: [],
                completed: false
            };

            jobs.push(job);
            renderJobs();
            showMessage('New job started', 'success');
        }

        function toggleJobCompletion(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (job) {
                job.completed = !job.completed;
                renderJobs();
            }
        }

        function deleteJob(jobId) {
            if (confirm('Delete this entire job and all its tasks?')) {
                jobs = jobs.filter(j => j.id !== jobId);
                renderJobs();
                showMessage('Job deleted', 'success');
            }
        }

        // Add task to job
        function addTaskToJob(jobId) {
            const input = document.getElementById(`taskInput-${jobId}`);
            const description = input.value.trim();
            
            if (!description) {
                showMessage('Please describe the task', 'error');
                return;
            }

            const job = jobs.find(j => j.id === jobId);
            if (!job) return;

            const task = {
                id: ++currentTaskId,
                description: description,
                completed: false,
                photos: []
            };

            job.tasks.push(task);
            input.value = '';
            renderJobs();
            showMessage('Task added', 'success');
        }

        function toggleTaskCompletion(jobId, taskId) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;
            
            const task = job.tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                renderJobs();
            }
        }

        function deleteTask(jobId, taskId) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;
            
            job.tasks = job.tasks.filter(t => t.id !== taskId);
            renderJobs();
            showMessage('Task deleted', 'success');
        }

        // Handle photo upload to task
        async function handleTaskPhotoUpload(jobId, taskId, files) {
            showLoading(true);

            try {
                const job = jobs.find(j => j.id === jobId);
                if (!job) return;
                
                const task = job.tasks.find(t => t.id === taskId);
                if (!task) return;

                for (const file of files) {
                    const compressed = await compressImage(file);
                    const photoData = {
                        jobId: jobId,
                        taskId: taskId,
                        dataUrl: compressed.dataUrl,
                        timestamp: new Date().toISOString()
                    };
                    
                    const photoId = await storePhoto(photoData);
                    task.photos.push({ id: photoId, dataUrl: compressed.dataUrl });
                }
                
                renderJobs();
                showMessage('Photos uploaded', 'success');
            } catch (error) {
                console.error('Error uploading photos:', error);
                showMessage('Error uploading photos', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function removePhotoFromTask(jobId, taskId, photoIndex) {
            try {
                const job = jobs.find(j => j.id === jobId);
                if (!job) return;
                
                const task = job.tasks.find(t => t.id === taskId);
                if (!task || !task.photos[photoIndex]) return;

                const photoId = task.photos[photoIndex].id;
                await deletePhoto(photoId);
                task.photos.splice(photoIndex, 1);
                renderJobs();
                showMessage('Photo removed', 'success');
            } catch (error) {
                console.error('Error removing photo:', error);
                showMessage('Error removing photo', 'error');
            }
        }

        // Render jobs
        function renderJobs() {
            const jobsList = document.getElementById('jobsList');
            
            if (jobs.length === 0) {
                jobsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîß</div><p>No jobs started yet. Select a customer request and click "Start New Job"</p></div>';
                return;
            }

            jobsList.innerHTML = jobs.map((job, jobIndex) => `
                <div class="job-card">
                    <div class="job-header">
                        <div class="job-title">
                            <div class="job-number">Job ${jobIndex + 1}</div>
                            <div class="job-request">üìã ${escapeHtml(job.requestText)}</div>
                        </div>
                        <div class="job-status ${job.completed ? 'completed' : 'in-progress'}">
                            ${job.completed ? '‚úì Complete' : '‚è≥ In Progress'}
                        </div>
                    </div>

                    <div class="job-actions">
                        <button class="btn ${job.completed ? 'btn-secondary' : 'btn-success'} btn-small" 
                                onclick="toggleJobCompletion(${job.id})">
                            ${job.completed ? 'Mark Incomplete' : 'Mark Complete'}
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteJob(${job.id})">Delete Job</button>
                    </div>

                    <div class="add-task-section">
                        <div class="add-task-input">
                            <input type="text" id="taskInput-${job.id}" placeholder="Describe a task you performed...">
                            <button class="btn btn-info btn-small" onclick="addTaskToJob(${job.id})">+ Add Task</button>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        ${job.tasks.length === 0 ? 
                            '<p style="color: #999; font-size: 14px; padding: 10px;">No tasks added yet. Add tasks to document what you did.</p>' :
                            job.tasks.map((task, taskIndex) => `
                                <div class="task-item ${task.completed ? 'completed' : ''}">
                                    <div class="task-header">
                                        <input type="checkbox" ${task.completed ? 'checked' : ''} 
                                               onchange="toggleTaskCompletion(${job.id}, ${task.id})">
                                        <div class="task-description">${escapeHtml(task.description)}</div>
                                    </div>
                                    
                                    <div class="task-actions">
                                        <button class="btn btn-danger btn-small" onclick="deleteTask(${job.id}, ${task.id})">Delete</button>
                                    </div>

                                    <div class="photo-section">
                                        <label class="photo-upload-label">
                                            üì∏ Add Photos
                                            <input type="file" accept="image/*" multiple 
                                                   onchange="handleTaskPhotoUpload(${job.id}, ${task.id}, this.files)">
                                        </label>
                                        ${task.photos.length > 0 ? `
                                            <div class="photo-grid">
                                                ${task.photos.map((photo, photoIndex) => `
                                                    <div class="photo-item">
                                                        <img src="${photo.dataUrl}" alt="Task evidence">
                                                        <button class="delete-photo-btn" 
                                                                onclick="removePhotoFromTask(${job.id}, ${task.id}, ${photoIndex})">√ó</button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `).join('');
        }

        // JSON Import/Export
        // Data management
        function collectFormData() {
            const methodologySelect = document.getElementById('methodology');
            const methodologyText = methodologySelect.options[methodologySelect.selectedIndex]?.text || '';
            
            return {
                id: 'current',
                timestamp: new Date().toISOString(),
                studentName: document.getElementById('studentName').value,
                jobDate: document.getElementById('jobDate').value,
                jobLocation: document.getElementById('jobLocation').value,
                vehicleReg: document.getElementById('vehicleReg').value,
                vehicleMake: document.getElementById('vehicleMake').value,
                vehicleYear: document.getElementById('vehicleYear').value,
                vehicleOdometer: document.getElementById('vehicleOdometer').value,
                methodology: methodologySelect.value,
                methodologyText: methodologyText,
                methodologyNotes: document.getElementById('methodologyNotes').value,
                tools: tools,
                technicalData: document.getElementById('technicalData').value,
                learnerProfile: document.getElementById('learnerProfile').value,
                photos: photos,
                signature: signatureImage,
                customerRequests: customerRequests,
                jobs: jobs
            };
        }

        function populateFormFromData(data) {
            document.getElementById('studentName').value = data.studentName || '';
            document.getElementById('jobDate').value = data.jobDate || '';
            document.getElementById('jobLocation').value = data.jobLocation || '';
            document.getElementById('vehicleReg').value = data.vehicleReg || '';
            document.getElementById('vehicleMake').value = data.vehicleMake || '';
            document.getElementById('vehicleYear').value = data.vehicleYear || '';
            document.getElementById('vehicleOdometer').value = data.vehicleOdometer || '';
            document.getElementById('methodology').value = data.methodology || '';
            document.getElementById('methodologyNotes').value = data.methodologyNotes || '';
            document.getElementById('technicalData').value = data.technicalData || '';
            document.getElementById('learnerProfile').value = data.learnerProfile || '';
            
            customerRequests = data.customerRequests || [];
            jobs = data.jobs || [];
            tools = data.tools || [];
            photos = data.photos || [];
            signatureImage = data.signature || null;
            
            currentJobId = jobs.length > 0 ? Math.max(...jobs.map(j => j.id)) : 0;
            currentTaskId = 0;
            currentToolId = tools.length > 0 ? Math.max(...tools.map(t => t.id)) : 0;
            jobs.forEach(job => {
                job.tasks.forEach(task => {
                    if (task.id > currentTaskId) currentTaskId = task.id;
                });
            });
            
            renderRequests();
            updateRequestDropdown();
            renderTools();
            renderJobs();
            displayPhotos();
        }

        function populateForm(data) {
            populateFormFromData(data);
        }

        function saveJobCard() {
            showLoading(true);
            try {
                const data = collectFormData();
                
                if (!validateFormData(data)) {
                    showMessage('Invalid data format', 'error');
                    showLoading(false);
                    return;
                }
                
                if (useLocalStorage) {
                    try {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                        showMessage('Job card saved (local storage)', 'success');
                    } catch (error) {
                        if (error.name === 'QuotaExceededError') {
                            showMessage('Storage quota exceeded. Please export to backup.', 'error');
                        } else {
                            showMessage('Error saving job card', 'error');
                        }
                    }
                    showLoading(false);
                } else {
                    try {
                        const transaction = db.transaction([STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        const request = store.put(data);
                        
                        request.onerror = () => {
                            if (request.error.name === 'QuotaExceededError') {
                                showMessage('Storage quota exceeded. Please export to backup.', 'error');
                            } else {
                                showMessage('Error saving job card', 'error');
                            }
                            showLoading(false);
                        };
                        
                        transaction.oncomplete = () => {
                            showMessage('Job card saved successfully!', 'success');
                            showLoading(false);
                        };
                    } catch (error) {
                        showMessage('Error saving job card: ' + error.message, 'error');
                        showLoading(false);
                    }
                }
            } catch (error) {
                console.error('Error in saveJobCard:', error);
                showMessage('Error saving job card', 'error');
                showLoading(false);
            }
        }

        function loadJobCard() {
            showLoading(true);
            try {
                if (useLocalStorage) {
                    const dataStr = localStorage.getItem(STORAGE_KEY);
                    if (dataStr) {
                        try {
                            const data = JSON.parse(dataStr);
                            if (validateFormData(data)) {
                                populateForm(data);
                                showMessage('Job card loaded (local storage)', 'success');
                            } else {
                                showMessage('Saved data is invalid', 'error');
                            }
                        } catch (parseError) {
                            showMessage('Error parsing saved data', 'error');
                        }
                    } else {
                        showMessage('No saved job card found', 'error');
                    }
                    showLoading(false);
                } else {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get('current');
                    
                    request.onsuccess = () => {
                        const data = request.result;
                        if (data && validateFormData(data)) {
                            populateForm(data);
                            showMessage('Job card loaded!', 'success');
                        } else {
                            showMessage('No saved job card found', 'error');
                        }
                        showLoading(false);
                    };
                    
                    request.onerror = () => {
                        showMessage('Error loading job card', 'error');
                        showLoading(false);
                    };
                }
            } catch (error) {
                console.error('Error in loadJobCard:', error);
                showMessage('Error loading job card', 'error');
                showLoading(false);
            }
        }

        function exportToPDF() {
            showLoading(true);
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const data = collectFormData();
                
                let yPos = 10;
                const lineHeight = 5;
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 10;
                const contentWidth = pageWidth - (margin * 2);
                
                // Professional header
                doc.setFillColor(30, 60, 114);
                doc.rect(0, 0, pageWidth, 25, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('MOTOR VEHICLE JOB CARD', pageWidth / 2, 12, { align: 'center' });
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                const dateStr = new Date().toLocaleDateString('en-GB', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                doc.text(`Report Generated: ${dateStr}`, pageWidth / 2, 20, { align: 'center' });
                
                yPos = 32;
                doc.setTextColor(0, 0, 0);
                
                const checkNewPage = (spaceNeeded = 20) => {
                    if (yPos + spaceNeeded > pageHeight - 10) {
                        doc.addPage();
                        yPos = 15;
                    }
                };
                
                // Section: Student & Vehicle Information
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setFillColor(220, 220, 220);
                doc.rect(margin, yPos - 2, contentWidth, 6, 'F');
                doc.text('STUDENT & VEHICLE INFORMATION', margin + 2, yPos + 2);
                yPos += 10;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                
                // Two column layout
                const col1X = margin;
                const col2X = pageWidth / 2;
                
                // Left column
                doc.text('Student Name:', col1X, yPos);
                doc.setFont(undefined, 'bold');
                doc.text(data.studentName || 'N/A', col1X + 35, yPos);
                doc.setFont(undefined, 'normal');
                
                // Right column
                doc.text('Date:', col2X, yPos);
                doc.setFont(undefined, 'bold');
                doc.text(data.jobDate || 'N/A', col2X + 15, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 6;
                
                // Location and registration
                doc.text('Location:', col1X, yPos);
                doc.setFont(undefined, 'bold');
                doc.text(data.jobLocation || 'N/A', col1X + 35, yPos);
                doc.setFont(undefined, 'normal');
                
                doc.text('Reg No:', col2X, yPos);
                doc.setFont(undefined, 'bold');
                doc.text(data.vehicleReg || 'N/A', col2X + 15, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 6;
                
                // Vehicle details
                doc.text('Vehicle:', col1X, yPos);
                doc.setFont(undefined, 'bold');
                let vehicleText = data.vehicleMake || 'N/A';
                if (data.vehicleYear) vehicleText += ` (${data.vehicleYear})`;
                doc.text(vehicleText, col1X + 35, yPos);
                doc.setFont(undefined, 'normal');
                
                doc.text('Odometer:', col2X, yPos);
                doc.setFont(undefined, 'bold');
                doc.text(data.vehicleOdometer ? `${data.vehicleOdometer} miles` : 'N/A', col2X + 15, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 10;
                
                // Section: Customer Requests
                if (data.customerRequests.length > 0) {
                    checkNewPage(25);
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setFillColor(220, 220, 220);
                    doc.rect(margin, yPos - 2, contentWidth, 6, 'F');
                    doc.text('CUSTOMER REQUESTS', margin + 2, yPos + 2);
                    yPos += 8;
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    data.customerRequests.forEach((req, idx) => {
                        doc.text(`${idx + 1}. [${req.completed ? '‚úì' : '  '}] ${req.text}`, margin + 3, yPos);
                        yPos += 5;
                    });
                    yPos += 2;
                }
                
                // Section: Methodology
                if (data.methodologyText) {
                    checkNewPage(20);
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setFillColor(220, 220, 220);
                    doc.rect(margin, yPos - 2, contentWidth, 6, 'F');
                    doc.text('METHODOLOGY', margin + 2, yPos + 2);
                    yPos += 8;
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text(data.methodologyText, margin + 3, yPos);
                    yPos += 5;
                    
                    if (data.methodologyNotes) {
                        doc.setFont(undefined, 'normal');
                        const noteLines = doc.splitTextToSize(`Notes: ${data.methodologyNotes}`, contentWidth - 6);
                        doc.text(noteLines, margin + 3, yPos);
                        yPos += (noteLines.length * 4) + 2;
                    }
                    yPos += 2;
                }
                
                // Section: Tools & Equipment
                if (data.tools && data.tools.length > 0) {
                    checkNewPage(25);
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setFillColor(220, 220, 220);
                    doc.rect(margin, yPos - 2, contentWidth, 6, 'F');
                    doc.text('TOOLS & EQUIPMENT', margin + 2, yPos + 2);
                    yPos += 8;
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    data.tools.forEach((tool, idx) => {
                        doc.text(`‚Ä¢ ${tool.name}`, margin + 3, yPos);
                        yPos += 4;
                    });
                    yPos += 2;
                }
                
                // Section: Technical Data
                if (data.technicalData) {
                    checkNewPage(20);
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setFillColor(220, 220, 220);
                    doc.rect(margin, yPos - 2, contentWidth, 6, 'F');
                    doc.text('TECHNICAL DATA & MEASUREMENTS', margin + 2, yPos + 2);
                    yPos += 8;
                    
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    const techLines = doc.splitTextToSize(data.technicalData, contentWidth - 6);
                    doc.text(techLines, margin + 3, yPos);
                    yPos += (techLines.length * 4) + 2;
                }
                
                // Section: Jobs & Tasks
                if (data.jobs.length > 0) {
                    data.jobs.forEach((job, jobIdx) => {
                        checkNewPage(20);
                        
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'bold');
                        doc.setFillColor(100, 150, 200);
                        doc.setTextColor(255, 255, 255);
                        doc.rect(margin, yPos - 2, contentWidth, 6, 'F');
                        doc.text(`JOB ${jobIdx + 1}: ${job.title}`, margin + 2, yPos + 2);
                        doc.setTextColor(0, 0, 0);
                        yPos += 8;
                        
                        if (job.description) {
                            doc.setFontSize(8);
                            doc.setFont(undefined, 'italic');
                            const descLines = doc.splitTextToSize(job.description, contentWidth - 6);
                            doc.text(descLines, margin + 2, yPos);
                            yPos += (descLines.length * 3) + 2;
                        }
                        
                        if (job.tasks && job.tasks.length > 0) {
                            job.tasks.forEach((task, taskIdx) => {
                                checkNewPage(10);
                                doc.setFontSize(8);
                                doc.setFont(undefined, 'bold');
                                doc.text(`  Task ${taskIdx + 1}: [${task.completed ? '‚úì' : '  '}]`, margin + 3, yPos);
                                yPos += 4;
                                
                                if (task.description) {
                                    doc.setFont(undefined, 'normal');
                                    const taskLines = doc.splitTextToSize(task.description, contentWidth - 10);
                                    doc.text(taskLines, margin + 6, yPos);
                                    yPos += (taskLines.length * 3) + 1;
                                }
                            });
                        }
                        yPos += 2;
                    });
                }
                
                // Section: Photos
                if (photos && photos.length > 0) {
                    checkNewPage(15);
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setFillColor(220, 220, 220);
                    doc.rect(margin, yPos - 2, contentWidth, 6, 'F');
                    doc.text('PHOTOGRAPHIC EVIDENCE', margin + 2, yPos + 2);
                    yPos += 8;
                    
                    const imgWidth = 45;
                    const imgHeight = 34;
                    const spacing = 6;
                    let xPos = margin;
                    let imgsInRow = 0;
                    const imgsPerRow = Math.floor(contentWidth / (imgWidth + spacing));
                    
                    photos.forEach((photo, idx) => {
                        if (imgsInRow >= imgsPerRow) {
                            xPos = margin;
                            yPos += imgHeight + spacing;
                            imgsInRow = 0;
                            checkNewPage(imgHeight + 10);
                        }
                        
                        try {
                            doc.addImage(photo.dataUrl, 'JPEG', xPos, yPos, imgWidth, imgHeight);
                            doc.setDrawColor(150);
                            doc.rect(xPos, yPos, imgWidth, imgHeight);
                        } catch (err) {
                            console.error('Error adding image:', err);
                        }
                        
                        xPos += imgWidth + spacing;
                        imgsInRow++;
                    });
                    yPos += imgHeight + 8;
                }
                
                // Section: Signature & Reflection
                checkNewPage(35);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setFillColor(220, 220, 220);
                doc.rect(margin, yPos - 2, contentWidth, 6, 'F');
                doc.text('LEARNER SIGNATURE & REFLECTION', margin + 2, yPos + 2);
                yPos += 10;
                
                // Signature canvas area
                if (signatureImage) {
                    try {
                        doc.addImage(signatureImage, 'PNG', margin, yPos, 60, 25);
                        doc.setDrawColor(0);
                        doc.rect(margin, yPos, 60, 25);
                    } catch (err) {
                        console.error('Error adding signature:', err);
                        doc.text('Signature: ________________________', margin + 2, yPos + 15);
                    }
                } else {
                    doc.setFontSize(9);
                    doc.text('Learner Signature: ________________________', margin + 2, yPos + 15);
                }
                yPos += 30;
                
                // Learner reflection
                if (data.learnerProfile) {
                    checkNewPage(15);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.text('Learner Reflection:', margin, yPos);
                    yPos += 5;
                    
                    const reflectionLines = doc.splitTextToSize(data.learnerProfile, contentWidth - 4);
                    doc.setFontSize(8);
                    doc.text(reflectionLines, margin + 2, yPos);
                }
                
                // Footer on all pages
                const pageCount = doc.internal.pages.length;
                for (let i = 2; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text(`Page ${i - 1} of ${pageCount - 1}`, pageWidth / 2, pageHeight - 5, { align: 'center' });
                }
                
                // Save PDF
                const filename = `JobCard_${data.studentName || 'Report'}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                showMessage('PDF exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting PDF:', error);
                showMessage('Error exporting PDF', 'error');
            } finally {
                showLoading(false);
            }
        }

        function clearForm() {
            if (confirm('Clear all data? This cannot be undone.')) {
                showLoading(true);
                try {
                    document.getElementById('studentName').value = '';
                    document.getElementById('jobDate').value = '';
                    document.getElementById('jobLocation').value = '';
                    document.getElementById('vehicleReg').value = '';
                    document.getElementById('vehicleMake').value = '';
                    document.getElementById('vehicleYear').value = '';
                    document.getElementById('vehicleOdometer').value = '';
                    document.getElementById('methodology').value = '';
                    document.getElementById('methodologyNotes').value = '';
                    document.getElementById('technicalData').value = '';
                    document.getElementById('learnerProfile').value = '';
                    document.getElementById('templateSelect').value = '';
                    
                    // Clear photos and signature
                    photos = [];
                    signatureImage = null;
                    document.getElementById('photoGallery').innerHTML = '';
                    clearSignature();
                    
                    customerRequests = [];
                    jobs = [];
                    tools = [];
                    currentJobId = 0;
                    currentTaskId = 0;
                    currentToolId = 0;
                    
                    renderRequests();
                    updateRequestDropdown();
                    renderTools();
                    renderJobs();
                    
                    if (useLocalStorage) {
                        try {
                            localStorage.removeItem(STORAGE_KEY);
                            showMessage('All data cleared', 'success');
                            showLoading(false);
                        } catch (error) {
                            console.error('Error clearing localStorage:', error);
                            showMessage('Error clearing data', 'error');
                            showLoading(false);
                        }
                    } else {
                        const transaction = db.transaction([STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        const request = store.delete('current');
                        
                        request.onerror = () => {
                            showMessage('Error clearing data', 'error');
                            showLoading(false);
                        };
                        
                        transaction.oncomplete = () => {
                            showMessage('All data cleared', 'success');
                            showLoading(false);
                        };
                    }
                } catch (error) {
                    console.error('Error clearing form:', error);
                    showMessage('Error clearing data', 'error');
                    showLoading(false);
                }
            }
        }

        function showMessage(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'block';
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('active');
            } else {
                loading.classList.remove('active');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Multiple Job Cards Management
        function saveAsNewCard() {
            const cardName = document.getElementById('cardName').value.trim();
            
            if (!cardName) {
                showMessage('Please enter a name for this job card', 'error');
                return;
            }
            
            if (cardName.length > 100) {
                showMessage('Card name too long (max 100 characters)', 'error');
                return;
            }

            showLoading(true);
            try {
                const data = collectFormData();
                if (!validateFormData(data)) {
                    showMessage('Invalid data format', 'error');
                    showLoading(false);
                    return;
                }
                
                const cardId = Date.now().toString();
                const cardData = {
                    id: cardId,
                    name: cardName,
                    timestamp: new Date().toISOString(),
                    data: data
                };

                if (useLocalStorage) {
                    try {
                        const savedCards = JSON.parse(localStorage.getItem('saved_cards') || '{}');
                        savedCards[cardId] = cardData;
                        localStorage.setItem('saved_cards', JSON.stringify(savedCards));
                        document.getElementById('cardName').value = '';
                        loadSavedCards();
                        showMessage(`Job card "${cardName}" saved!`, 'success');
                    } catch (error) {
                        if (error.name === 'QuotaExceededError') {
                            showMessage('Storage quota exceeded. Please export to backup.', 'error');
                        } else {
                            showMessage('Error saving job card', 'error');
                        }
                    }
                    showLoading(false);
                } else {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.put(cardData);
                    
                    request.onerror = () => {
                        if (request.error.name === 'QuotaExceededError') {
                            showMessage('Storage quota exceeded. Please export to backup.', 'error');
                        } else {
                            showMessage('Error saving job card', 'error');
                        }
                        showLoading(false);
                    };
                    
                    transaction.oncomplete = () => {
                        document.getElementById('cardName').value = '';
                        loadSavedCards();
                        showMessage(`Job card "${cardName}" saved!`, 'success');
                        showLoading(false);
                    };
                }
            } catch (error) {
                console.error('Error in saveAsNewCard:', error);
                showMessage('Error saving job card', 'error');
                showLoading(false);
            }
        }

        function loadSavedCards() {
            try {
                const cardsList = document.getElementById('savedCardsList');
                
                if (useLocalStorage) {
                    try {
                        const savedCards = JSON.parse(localStorage.getItem('saved_cards') || '{}');
                        const allCards = Object.values(savedCards).filter(card => card.id && card.name);
                        
                        if (allCards.length === 0) {
                            cardsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìë</div><p>No saved job cards yet</p></div>';
                            return;
                        }

                        cardsList.innerHTML = allCards.map(card => {
                            const date = new Date(card.timestamp).toLocaleDateString();
                            return `
                                <div class="saved-card-item">
                                    <div class="card-info">
                                        <div class="card-name">${escapeHtml(card.name)}</div>
                                        <div class="card-date">Saved: ${date}</div>
                                    </div>
                                    <div class="card-actions">
                                        <button class="load-btn" onclick="loadCard('${card.id}')">Load</button>
                                        <button class="delete-card-btn" onclick="deleteCard('${card.id}')">Delete</button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } catch (error) {
                        console.error('Error loading saved cards from localStorage:', error);
                        cardsList.innerHTML = '<div class="error-state">Error loading saved cards</div>';
                    }
                } else {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();

                    request.onsuccess = () => {
                        const allCards = request.result.filter(card => card.id !== 'current' && card.name);

                        if (allCards.length === 0) {
                            cardsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìë</div><p>No saved job cards yet</p></div>';
                            return;
                        }

                        cardsList.innerHTML = allCards.map(card => {
                            const date = new Date(card.timestamp).toLocaleDateString();
                            return `
                                <div class="saved-card-item">
                                    <div class="card-info">
                                        <div class="card-name">${escapeHtml(card.name)}</div>
                                        <div class="card-date">Saved: ${date}</div>
                                    </div>
                                    <div class="card-actions">
                                        <button class="load-btn" onclick="loadCard('${card.id}')">Load</button>
                                        <button class="delete-card-btn" onclick="deleteCard('${card.id}')">Delete</button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    };
                    
                    request.onerror = () => {
                        console.error('Error loading cards from IndexedDB');
                        cardsList.innerHTML = '<div class="error-state">Error loading saved cards</div>';
                    };
                }
            } catch (error) {
                console.error('Error loading saved cards:', error);
            }
        }

        function loadCard(cardId) {
            showLoading(true);
            try {
                if (useLocalStorage) {
                    try {
                        const savedCards = JSON.parse(localStorage.getItem('saved_cards') || '{}');
                        const cardData = savedCards[cardId];
                        
                        if (!cardData || !cardData.data) {
                            showMessage('Job card not found', 'error');
                            showLoading(false);
                            return;
                        }
                        
                        if (!validateFormData(cardData.data)) {
                            showMessage('Card data is invalid or corrupted', 'error');
                            showLoading(false);
                            return;
                        }
                        
                        populateFormFromData(cardData.data);
                        currentJobId = 0;
                        currentTaskId = 0;
                        currentToolId = 0;
                        showMessage(`Job card "${cardData.name}" loaded!`, 'success');
                        window.scrollTo(0, 0);
                        showLoading(false);
                    } catch (error) {
                        console.error('Error loading from localStorage:', error);
                        showMessage('Error loading job card', 'error');
                        showLoading(false);
                    }
                } else {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(cardId);

                    request.onsuccess = () => {
                        const card = request.result;
                        if (card && card.data) {
                            if (!validateFormData(card.data)) {
                                showMessage('Card data is invalid or corrupted', 'error');
                                showLoading(false);
                                return;
                            }
                            populateFormFromData(card.data);
                            currentJobId = 0;
                            currentTaskId = 0;
                            currentToolId = 0;
                            showMessage(`Job card "${card.name}" loaded!`, 'success');
                            window.scrollTo(0, 0);
                        } else {
                            showMessage('Job card not found', 'error');
                        }
                        showLoading(false);
                    };

                    request.onerror = () => {
                        showMessage('Error loading job card', 'error');
                        showLoading(false);
                    };
                }
            } catch (error) {
                console.error('Error loading card:', error);
                showMessage('Error loading job card', 'error');
                showLoading(false);
            }
        }

        function deleteCard(cardId) {
            if (confirm('Delete this saved job card? This cannot be undone.')) {
                showLoading(true);
                try {
                    if (useLocalStorage) {
                        try {
                            const savedCards = JSON.parse(localStorage.getItem('saved_cards') || '{}');
                            delete savedCards[cardId];
                            localStorage.setItem('saved_cards', JSON.stringify(savedCards));
                            loadSavedCards();
                            showMessage('Job card deleted', 'success');
                            showLoading(false);
                        } catch (error) {
                            console.error('Error deleting from localStorage:', error);
                            showMessage('Error deleting job card', 'error');
                            showLoading(false);
                        }
                    } else {
                        const transaction = db.transaction([STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        const request = store.delete(cardId);
                        
                        request.onerror = () => {
                            showMessage('Error deleting job card', 'error');
                            showLoading(false);
                        };
                        
                        transaction.oncomplete = () => {
                            loadSavedCards();
                            showMessage('Job card deleted', 'success');
                            showLoading(false);
                        };
                    }
                } catch (error) {
                    console.error('Error deleting card:', error);
                    showMessage('Error deleting job card', 'error');
                    showLoading(false);
                }
            }
        }

        // Tabs setup
        function initTabs() {
            const tabs = document.querySelectorAll('.tabs .tab[data-tab-target]');
            const panels = document.querySelectorAll('.section[data-tab]');

            function activate(tabName) {
                tabs.forEach(btn => btn.classList.toggle('active', btn.dataset.tabTarget === tabName));
                panels.forEach(p => p.classList.toggle('active', p.dataset.tab === tabName));
                try { localStorage.setItem('activeTab', tabName); } catch {}
            }

            tabs.forEach(btn => btn.addEventListener('click', () => activate(btn.dataset.tabTarget)));

            let initial = 'template';
            try {
                const saved = localStorage.getItem('activeTab');
                if (saved) initial = saved;
            } catch {}
            activate(initial);
        }

        async function initApp() {
            try {
                await initDB();
                document.getElementById('jobDate').valueAsDate = new Date();
                renderRequests();
                updateRequestDropdown();
                renderTools();
                renderJobs();
                loadSavedCards();
                loadTemplates();
                setupSignatureCanvas();
                initTabs();
            } catch (error) {
                console.error('Error initializing app:', error);
                showMessage('Error initializing app', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>