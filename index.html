<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motor Vehicle Job Card</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
              background: #f5f5f5;
            min-height: 100vh;
            padding: 0;
            line-height: 1.5;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
              background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
              background: #111111;
              color: #ffffff;
              padding: 12px 16px 14px 16px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
              box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        }

        .header h1 {
              font-size: 18px;
              font-weight: 600;
              margin-bottom: 2px;
              letter-spacing: -0.3px;
        }

        .header p {
              font-size: 12px;
              opacity: 0.8;
              font-weight: 400;
        }

        .progress-bar-container {
              margin-top: 8px;
              background: rgba(255, 255, 255, 0.2);
              border-radius: 8px;
              height: 6px;
            overflow: hidden;
        }

        .progress-bar {
              background: #ffffff;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
              border-radius: 8px;
        }

        .progress-text {
              font-size: 11px;
              margin-top: 4px;
              opacity: 0.85;
              font-weight: 500;
        }

        .form-content {
            padding: 16px;
        }

        .section {
              background: #ffffff;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 17px;
            color: #1c1c1e;
            margin-bottom: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            letter-spacing: -0.3px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #3c3c43;
            margin-bottom: 8px;
            letter-spacing: -0.1px;
        }

        input[type="text"],
        input[type="date"],
        input[type="file"],
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d1d6;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s;
            font-family: inherit;
            background: white;
            color: #1c1c1e;
            -webkit-appearance: none;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #111111;
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.08);
        }

        input.error,
        textarea.error,
        select.error {
            border-color: #333333;
        }

        .field-error {
            color: #333333;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .field-error.active {
            display: block;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            letter-spacing: -0.2px;
            touch-action: manipulation;
            min-height: 44px;
            min-width: 44px;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-small {
            padding: 12px 16px;
            font-size: 14px;
            border-radius: 10px;
        }

        .btn-primary {
            background: #111111;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #000000;
        }

        .btn-secondary {
            background: #444444;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #333333;
        }

        .btn-success {
            background: #222222;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #111111;
        }

        .btn-danger {
            background: #333333;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #222222;
        }

        .btn-info {
            background: #555555;
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background: #444444;
        }

        .btn-ghost {
            background: #ffffff;
            color: #3c3c43;
            border: 1px solid #dddddd;
        }

        .btn-ghost:hover:not(:disabled) {
            background: #f0f0f0;
        }

        .status-message {
            padding: 14px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            display: none;
            animation: slideIn 0.3s ease;
            font-size: 14px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-message.success {
              background: #f0f0f0;
              color: #111111;
        }

        .status-message.error {
              background: #ededed;
              color: #111111;
        }

        .status-message.info {
              background: #f5f5f5;
              color: #111111;
        }

        .info-box {
              background: #f5f5f5;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            color: #3c3c43;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .auto-save-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
                background: rgba(17, 17, 17, 0.95);
                color: #ffffff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 99;
            backdrop-filter: blur(10px);
        }

        .auto-save-indicator.active {
            opacity: 1;
        }

        .tabs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 16px;
            background: white;
            border-bottom: 1px solid #E5E5EA;
        }

        .tab {
            flex: 0 0 auto;
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid #E5E5EA;
            background: #F9F9FB;
            color: #1c1c1e;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #F0F0F5;
        }

        .tab.active {
              background: #111111;
              color: #ffffff;
              border-color: #111111;
        }

        .hamburger-btn {
            display: none;
            position: sticky;
            top: 60px;
            z-index: 99;
            width: 100%;
            padding: 12px 16px;
            background: white;
            border: none;
            border-bottom: 1px solid #E5E5EA;
            text-align: left;
            font-size: 16px;
            font-weight: 600;
            color: #1c1c1e;
            cursor: pointer;
        }

        .hamburger-btn::before {
            content: '‚ò∞ Sections';
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 101;
            animation: fadeIn 0.2s;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-content {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            max-width: 320px;
            height: 100%;
            background: white;
            overflow-y: auto;
            z-index: 102;
            animation: slideInLeft 0.3s ease-out;
        }

        .mobile-menu-close {
            position: sticky;
            top: 0;
            padding: 16px;
              background: #111111;
              color: #ffffff;
            border: none;
            font-size: 24px;
            cursor: pointer;
            width: 100%;
            text-align: right;
        }

        .mobile-menu .tab {
            width: 100%;
            margin: 0;
            border: none;
            border-bottom: 1px solid #E5E5EA;
            border-radius: 0;
            background: white;
            padding: 16px;
            text-align: left;
        }

        .mobile-menu .tab:hover {
            background: #F9F9FB;
        }

        .mobile-menu .tab.active {
              background: #f0f0f0;
              color: #111111;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        .section[data-tab] { display: none; }
        .section[data-tab].active { display: block; }

        .request-item {
            background: #F9F9FB;
            padding: 14px 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid #E5E5EA;
            transition: all 0.2s;
        }

        .request-item:hover {
            background: #F0F0F5;
            border-color: #d1d1d6;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }

        .request-item.completed {
              background: #f0f0f0;
              border-color: #d1d1d6;
            opacity: 1;
        }

        .request-item .request-text {
            flex: 1;
            font-size: 15px;
            color: #1c1c1e;
            font-weight: 500;
        }

        .request-item.completed .request-text {
            text-decoration: line-through;
            color: #8E8E93;
        }

        .request-item .delete-btn {
            padding: 7px 14px;
              background: #333333;
              color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            flex-shrink: 0;
            font-weight: 600;
            transition: all 0.2s;
        }

        .request-item .delete-btn:hover {
              background: #222222;
            transform: scale(1.05);
        }

        .add-request-input {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .add-request-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d1d6;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
        }

        .add-request-input input:focus {
            outline: none;
              border-color: #111111;
              box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.08);
        }

        .add-request-input button {
            padding: 12px 24px;
            font-weight: 600;
        }

        .job-card {
            background: white;
            border: 2px solid #E5E5EA;
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .job-card:hover {
              border-color: #111111;
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .job-card.completed {
              background: #f5f5f5;
              border-color: #d1d1d6;
        }

        .job-card > div {
            transition: opacity 0.2s ease;
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            gap: 12px;
            transition: all 0.2s ease;
        }

        .job-header:hover {
              background: rgba(0, 0, 0, 0.04);
            border-radius: 8px;
            padding: 8px;
            margin: -8px -8px 8px -8px;
        }

        .job-title {
            flex: 1;
        }

        .job-number {
            font-size: 12px;
            color: #8E8E93;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .job-request {
            font-size: 16px;
            color: #1c1c1e;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.3px;
        }

        .job-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 13px;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 600;
            letter-spacing: 0.2px;
            white-space: nowrap;
            min-width: 110px;
            text-align: center;
        }

        .job-status.completed {
              background: #f0f0f0;
              color: #111111;
        }

        .job-status.in-progress {
              background: #f5f5f5;
              color: #111111;
        }

        .task-item {
              background: #f9f9f9;
              border-left: 4px solid #111111;
            padding: 14px;
            margin-bottom: 12px;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .task-item:hover {
              background: #f2f2f2;
              border-left-color: #000000;
        }

        .task-header {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .task-header input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            margin-top: 2px;
            flex-shrink: 0;
              accent-color: #111111;
        }

        .task-description {
            flex: 1;
            font-size: 15px;
            color: #1c1c1e;
            font-weight: 500;
        }

        .task-item.completed {
            opacity: 0.7;
              background: #f0f0f0;
              border-left-color: #111111;
        }

        .task-item.completed .task-description {
            text-decoration: line-through;
            color: #8E8E93;
        }

        .task-time-info {
            font-size: 11px;
            color: #8E8E93;
            margin-top: 4px;
            font-weight: 500;
        }

        .photo-section {
            margin-left: 30px;
            margin-top: 8px;
        }

        .photo-upload-label {
            display: inline-block;
            padding: 8px 14px;
              background: #111111;
              color: #ffffff;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .photo-upload-label:hover {
              background: #000000;
        }

        .photo-upload-label input[type="file"] {
            display: none;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            background: #f0f0f5;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .delete-photo-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
              background: rgba(17, 17, 17, 0.95);
              color: #ffffff;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        .photo-drop-zone {
            border: 2px dashed #d1d1d6;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin: 16px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-drop-zone:hover,
        .photo-drop-zone.drag-over {
              border-color: #111111;
              background: #f2f2f2;
        }

        .photo-drop-zone-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .photo-drop-zone-text {
            font-size: 14px;
            color: #8E8E93;
        }

        #photoGallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .photo-container {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            background: #f0f0f5;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .photo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-container .remove-photo {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
              background: rgba(17, 17, 17, 0.95);
              color: #ffffff;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
        }

        #signatureCanvas {
            border: 2px solid #E5E5EA;
            border-radius: 12px;
            cursor: crosshair;
            touch-action: none;
            background: white;
            width: 100%;
            max-width: 600px;
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8E8E93;
            font-size: 15px;
              background: #f5f5f5;
            border-radius: 12px;
            margin: 16px 0;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.6;
        }

        .bottom-actions {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 640px;
              background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(16px);
            padding: 8px 12px;
              border-top: 1px solid #dddddd;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.12);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            z-index: 200;
        }

        .bottom-actions .btn {
            padding: 10px 8px;
            font-size: 13px;
            min-height: 40px;
            white-space: nowrap;
        }

        .bottom-actions .btn-ghost {
            font-size: 20px;
            padding: 8px;
        }

        .keyboard-shortcuts-hint {
            position: fixed;
            bottom: 70px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 199;
            pointer-events: none;
        }

        .keyboard-shortcuts-hint.active {
            opacity: 1;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #E5E5EA;
              border-top-color: #111111;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            border: 0;
        }

        .saved-card-item {
            background: #F9F9FB;
            padding: 14px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #E5E5EA;
        }

        .card-info {
            flex: 1;
        }

        .card-name {
            font-size: 15px;
            font-weight: 600;
            color: #1c1c1e;
            margin-bottom: 4px;
        }

        .card-date {
            font-size: 12px;
            color: #8E8E93;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .load-btn {
            padding: 6px 12px;
              background: #111111;
              color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .delete-card-btn {
            padding: 6px 12px;
              background: #333333;
              color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .search-box {
            margin-bottom: 16px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d1d6;
            border-radius: 10px;
            font-size: 14px;
        }

        @media (max-width: 640px) {
            .container {
                padding: 0;
                border-radius: 0;
                margin: 0;
                min-height: 100vh;
            }

            .header {
                border-radius: 0;
                padding: 16px 20px;
            }

            .section {
                border-radius: 0;
                margin-bottom: 8px;
            }

            .tabs {
                display: none;
            }

            .hamburger-btn {
                display: block;
            }

            #photoGallery {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .task-description {
                word-wrap: break-word;
                word-break: break-word;
                overflow-wrap: break-word;
            }
        }

        /* Landscape orientation adjustments */
        @media (max-width: 1024px) and (orientation: landscape) {
            .header {
                padding: 12px 20px;
            }

            .header h1 {
                font-size: 18px;
            }

            .form-content {
                padding: 12px;
            }

            .section {
                padding: 14px;
                margin-bottom: 10px;
            }

            #photoGallery {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 8px;
            }

            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
                gap: 6px;
            }

            .container {
                max-width: 100%;
            }
        }

        .storage-indicator {
            display: inline-block;
              font-size: 10px;
              padding: 3px 10px;
              background: rgba(255, 255, 255, 0.12);
              border-radius: 10px;
              color: #ffffff;
              margin-top: 4px;
        }

        .storage-indicator.warning {
              background: rgba(255, 255, 255, 0.2);
              color: #ffffff;
        }

        .storage-indicator.critical {
              background: rgba(255, 255, 255, 0.3);
              color: #ffffff;
        }

        @media print {
            .header, .tabs, .hamburger-btn, .bottom-actions,
            .btn, .delete-btn, .photo-upload-label,
            .mobile-menu, .status-message, .auto-save-indicator,
            .keyboard-shortcuts-hint, .loading {
                display: none !important;
            }

            .section {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }

            body {
                background: white;
            }

            .container {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <div class="auto-save-indicator" id="autoSaveIndicator">
        Auto-saved ‚úì
    </div>

    <div class="keyboard-shortcuts-hint" id="keyboardHint">
        Ctrl+S: Save | Ctrl+E: Export | Ctrl+Arrow: Navigate
    </div>

    <div class="container">
        <div class="header">
            <h1>üöó Motor Vehicle Job Card</h1>
                  <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">0% Complete</div>
                <div class="storage-indicator" id="storageIndicator">Storage: Calculating...</div>
        </div>

        <button class="hamburger-btn" id="hamburgerBtn"></button>

        <div class="tabs" id="tabs">
            <button class="tab" data-tab-target="template">Template</button>
            <button class="tab" data-tab-target="info">Info</button>
            <button class="tab" data-tab-target="work">Jobs & Reports</button>
            <button class="tab" data-tab-target="reflection">Reflection</button>
            <button class="tab" data-tab-target="cards">Saved Cards</button>
            <button class="tab" data-tab-target="signature">Signature</button>
            <button class="tab" data-tab-target="actions">Save & Export</button>
        </div>

        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-menu-content">
                <button class="mobile-menu-close" id="mobileMenuClose">‚úï</button>
                <button class="tab" data-tab-target="template">Template</button>
                <button class="tab" data-tab-target="info">Info</button>
                <button class="tab" data-tab-target="work">Jobs & Reports</button>
                <button class="tab" data-tab-target="reflection">Reflection</button>
                <button class="tab" data-tab-target="cards">Saved Cards</button>
                <button class="tab" data-tab-target="signature">Signature</button>
                <button class="tab" data-tab-target="actions">Save & Export</button>
            </div>
        </div>

        <div class="form-content">
            <div class="status-message" id="statusMessage"></div>

            <!-- Template Selection -->
            <div class="section" data-tab="template">
                <h2 class="section-title">üìã Load Assessment Template</h2>
                <div class="info-box">
                    Select a template to load predefined requests and tools
                </div>
                <div class="form-group">
                    <label for="templateSelect">Choose Template</label>
                    <select id="templateSelect">
                        <option value="">-- Select a template --</option>
                    </select>
                    <small style="display: block; margin-top: 5px; color: #666;">Loading templates from json-templates/ folder...</small>
                </div>
                <div class="button-group">
                    <button class="btn btn-info btn-small" onclick="JobCardApp.templates.saveCurrentAsTemplate()">üíæ Save Current as Template</button>
                </div>
            </div>

            <!-- Student Information & Vehicle Details -->
            <div class="section" data-tab="info">
                <h2 class="section-title">üìã Student & Vehicle Information</h2>
                
                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #E5E5EA;">
                    <h3 style="font-size: 15px; font-weight: 600; color: #1c1c1e; margin-bottom: 12px;">Student Details</h3>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="studentFirstName">Student First Name *</label>
                            <input type="text" id="studentFirstName" placeholder="First name" required>
                            <div class="field-error" id="error-studentFirstName">First name is required</div>
                        </div>
                        <div class="form-group">
                            <label for="studentLastName">Student Last Name *</label>
                            <input type="text" id="studentLastName" placeholder="Last name" required>
                            <div class="field-error" id="error-studentLastName">Last name is required</div>
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="candidateNumber">Candidate Number *</label>
                            <input type="text" id="candidateNumber" placeholder="e.g., 12345678" pattern="\d{8}" required>
                            <div class="field-error" id="error-candidateNumber">Must be 8 digits</div>
                        </div>
                        <div class="form-group">
                            <label for="jobDate">Date *</label>
                            <input type="date" id="jobDate" required>
                            <div class="field-error" id="error-jobDate">Date is required</div>
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="unitTitle">Unit Title</label>
                            <input type="text" id="unitTitle" placeholder="e.g., Vehicle Systems Diagnosis">
                        </div>
                        <div class="form-group">
                            <label for="unitNumber">Unit Number *</label>
                            <input type="text" id="unitNumber" placeholder="e.g., 301" required>
                            <div class="field-error" id="error-unitNumber">Unit number is required</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="jobLocation">Location / Workshop</label>
                        <input type="text" id="jobLocation" placeholder="e.g., College Workshop">
                    </div>
                </div>

                <div>
                    <h3 style="font-size: 15px; font-weight: 600; color: #1c1c1e; margin-bottom: 12px;">üöó Vehicle Details</h3>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="vehicleReg">Registration Number *</label>
                            <input type="text" id="vehicleReg" placeholder="e.g., AB21XYZ" required>
                            <div class="field-error" id="error-vehicleReg">Registration is required</div>
                        </div>
                        <div class="form-group">
                            <label for="vehicleMake">Make & Model *</label>
                            <input type="text" id="vehicleMake" placeholder="e.g., Ford Focus 1.6" required>
                            <div class="field-error" id="error-vehicleMake">Make & model is required</div>
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="vehicleYear">Year</label>
                            <input type="text" id="vehicleYear" placeholder="e.g., 2020">
                        </div>
                        <div class="form-group">
                            <label for="vehicleOdometer">Odometer Reading (miles)</label>
                            <input type="text" id="vehicleOdometer" placeholder="e.g., 45000">
                            <div class="field-error" id="error-vehicleOdometer">Must be a number</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Requests & Jobs -->
            <div class="section" data-tab="work">
                <h2 class="section-title">üìã Jobs & Reports</h2>
                <div class="info-box">
                    <strong>Workflow:</strong> Create a job ‚Üí Click to expand ‚Üí Add reports, details, photos & evidence
                </div>
                
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <input type="text" id="newRequestInput" placeholder="Create new job (customer request)..." 
                               style="flex: 1; padding: 12px 16px; border: 1px solid #d1d1d6; border-radius: 12px; font-size: 16px;">
                        <button class="btn btn-primary" onclick="JobCardApp.requests.add()" style="padding: 12px 24px;">Create Job</button>
                    </div>
                    <div id="jobsList"></div>
                </div>
            </div>

            <!-- Learner Profile -->
            <div class="section" data-tab="reflection">
                <h2 class="section-title">üéì Learner Reflection</h2>
                <div class="form-group">
                    <label for="learnerProfile">Learner Profile Notes</label>
                    <textarea id="learnerProfile" placeholder="Reflection on what you learned and your progress..."></textarea>
                </div>
            </div>

            <!-- Multiple Job Cards Management -->
            <div class="section" data-tab="cards">
                <h2 class="section-title">üìë Saved Cards</h2>
                
                <div class="search-box">
                    <input type="text" id="cardSearch" placeholder="üîç Search saved cards..." oninput="JobCardApp.cards.search(this.value)">
                </div>
                
                <div class="two-column">
                    <div class="form-group">
                        <label for="cardName">Job Card Name</label>
                        <input type="text" id="cardName" placeholder="e.g., Engine Repair - Jan 2026">
                    </div>
                    <div class="button-group" style="margin-top: 22px;">
                        <button class="btn btn-info btn-small" onclick="JobCardApp.cards.saveAsNew()">üíæ Save As New Card</button>
                    </div>
                </div>
                <div id="savedCardsList" style="margin-top: 15px;"></div>
            </div>

            <!-- Learner Signature -->
            <div class="section" data-tab="signature">
                <h2 class="section-title">‚úèÔ∏è Learner Signature</h2>
                <div class="form-group">
                    <label>Sign Below</label>
                    <canvas id="signatureCanvas" width="600" height="150"></canvas>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="JobCardApp.signature.clear()" style="flex: 1;">Clear Signature</button>
                        <button type="button" class="btn btn-info" onclick="JobCardApp.signature.save()" style="flex: 1;">Save Signature</button>
                    </div>
                </div>
            </div>

            <!-- Save and Export Tab -->
            <div class="section" data-tab="actions">
                <h2 class="section-title">üíæ Save and Export</h2>

                <div class="info-box" style="margin-bottom: 12px; background: #f5f5f5; border-left: 4px solid #111111;">
                    <strong>Quick steps for learners:</strong>
                    <div style="margin-top: 6px; font-size: 13px; line-height: 1.5;">
                        <div>1) Tap üíæ Save to keep your work locally.</div>
                        <div>2) Tap üìÑ Export PDF to hand in / share.</div>
                        <div>3) Use üì• JSON to back up (includes photos).</div>
                    </div>
                </div>
                
                <div class="info-box" style="margin-bottom: 20px;">
                    <strong>Vehicle Information:</strong>
                    <div style="margin-top: 8px; font-size: 14px;">
                        <div>Registration: <span id="summaryVehicleReg" style="font-weight: 500;">--</span></div>
                        <div>Make/Model: <span id="summaryVehicleMake" style="font-weight: 500;">--</span></div>
                        <div>Year: <span id="summaryVehicleYear" style="font-weight: 500;">--</span></div>
                        <div>Odometer: <span id="summaryVehicleOdometer" style="font-weight: 500;">--</span> miles</div>
                    </div>
                </div>

                <div class="info-box" style="background: #f5f5f5; border-left: 4px solid #111111;">
                    <strong>Completion Status:</strong>
                    <div style="margin-top: 8px; font-size: 13px;">
                        <div>Requests Completed: <span id="completionRequests" style="font-weight: 600; color: #111111;">0/0</span></div>
                        <div>Tasks Completed: <span id="completionTasks" style="font-weight: 600; color: #111111;">0/0</span></div>
                    </div>
                </div>

                <div class="info-box" id="exportChecklist" style="background: #f5f5f5; border-left: 4px solid #111111;">
                    <strong>Export Readiness:</strong>
                    <div id="exportChecklistBody" style="margin-top: 8px; font-size: 13px;"></div>
                </div>

                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" id="exportBtnMain" onclick="JobCardApp.exports.toPDF()" style="flex: 1; min-width: 180px;">üìÑ Export PDF</button>
                    <button class="btn btn-ghost" onclick="JobCardApp.storage.save()">üíæ Save</button>
                    <button class="btn btn-success" onclick="JobCardApp.storage.load()">üìÇ Load Saved</button>
                </div>

                <div class="button-group" style="margin-top: 12px;">
                    <button class="btn btn-danger btn-small" onclick="JobCardApp.ui.clearForm()">üóëÔ∏è Clear All</button>
                </div>
            </div>

            <div class="bottom-actions">
                <button class="btn btn-ghost" onclick="JobCardApp.ui.navigateTab(-1)" title="Previous">‚¨ÖÔ∏è</button>
                <button class="btn btn-primary" onclick="JobCardApp.storage.save()">üíæ Save</button>
                <button class="btn btn-ghost" onclick="JobCardApp.ui.navigateTab(1)" title="Next">‚û°Ô∏è</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        // ============================================================================
        // MOTOR VEHICLE JOB CARD APPLICATION - ENHANCED VERSION
        // ============================================================================

        const JobCardApp = {
            // Application State
            state: {
                customerRequests: [],
                jobs: [],
                tools: [],
                photos: [],
                signatureImage: null,
                currentJobId: 0,
                currentTaskId: 0,
                currentToolId: 0,
                hasUnsavedChanges: false,
                isDrawing: false,
                lastX: 0,
                lastY: 0
            },

            // Configuration
            config: {
                DB_NAME: 'MotorVehicleJobCardDB',
                STORE_NAME: 'jobCards',
                PHOTO_STORE: 'photos',
                STORAGE_KEY: 'jobcard_data',
                TAB_SEQUENCE: ['template', 'info', 'work', 'reflection', 'cards', 'signature', 'actions'],
                AUTO_SAVE_INTERVAL: 30000, // 30 seconds
                MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
                ALLOWED_IMAGE_TYPES: ['image/jpeg', 'image/png', 'image/webp', 'image/gif'],
                IMAGE_MAX_WIDTH: 1200,
                IMAGE_QUALITY: 0.8
            },

            // Database
            db: null,
            useLocalStorage: false,
            autoSaveInterval: null,

            // ========================================================================
            // INITIALIZATION
            // ========================================================================
            
            async init() {
                try {
                    await this.database.init();
                    this.ui.setDefaultDate();
                    this.validation.setupValidation();
                    this.requests.render(); // Safe even if list is hidden
                    this.jobs.render();
                    this.cards.load();
                    this.templates.load();
                    this.signature.setup();
                    this.ui.initTabs();
                    this.ui.updateProgress();
                    this.photos.setupDragDrop();
                    this.keyboard.setup();
                    this.autoSave.start();
                    this.ui.trackChanges();
                    
                    // Show keyboard shortcuts hint briefly
                    setTimeout(() => {
                        document.getElementById('keyboardHint').classList.add('active');
                        setTimeout(() => {
                            document.getElementById('keyboardHint').classList.remove('active');
                        }, 3000);
                    }, 1000);
                    
                        // Update storage indicator
                        this.storageUsage.updateIndicator();
                        setInterval(() => this.storageUsage.updateIndicator(), 5000); // Update every 5 seconds
                } catch (error) {
                    console.error('Error initializing app:', error);
                    this.ui.showMessage('Error initializing app', 'error');
                }
            },

            // ========================================================================
            // DATABASE MODULE
            // ========================================================================
            
            database: {
                async init() {
                    return new Promise((resolve) => {
                        try {
                            const testDb = indexedDB.open('test');
                            testDb.onerror = () => {
                                console.warn('IndexedDB unavailable, using localStorage');
                                JobCardApp.useLocalStorage = true;
                                resolve(null);
                            };
                            testDb.onsuccess = () => {
                                testDb.result.close();
                                const request = indexedDB.open(JobCardApp.config.DB_NAME, 2);
                                request.onerror = () => {
                                    console.warn('IndexedDB error, using localStorage');
                                    JobCardApp.useLocalStorage = true;
                                    resolve(null);
                                };
                                request.onsuccess = () => {
                                    JobCardApp.db = request.result;
                                    resolve(JobCardApp.db);
                                };
                                request.onupgradeneeded = (event) => {
                                    const database = event.target.result;
                                    if (!database.objectStoreNames.contains(JobCardApp.config.STORE_NAME)) {
                                        database.createObjectStore(JobCardApp.config.STORE_NAME, { keyPath: 'id' });
                                    }
                                    if (!database.objectStoreNames.contains(JobCardApp.config.PHOTO_STORE)) {
                                        database.createObjectStore(JobCardApp.config.PHOTO_STORE, { keyPath: 'id', autoIncrement: true });
                                    }
                                };
                            };
                        } catch (error) {
                            console.warn('IndexedDB not available:', error);
                            JobCardApp.useLocalStorage = true;
                            resolve(null);
                        }
                    });
                }
            },

            // ========================================================================
            // VALIDATION MODULE
            // ========================================================================
            
            validation: {
                rules: {
                    studentFirstName: { required: true, message: 'First name is required' },
                    studentLastName: { required: true, message: 'Last name is required' },
                    candidateNumber: { 
                        required: true, 
                        pattern: /^\d{8}$/, 
                        message: 'Must be 8 digits' 
                    },
                    jobDate: { required: true, message: 'Date is required' },
                    unitNumber: { required: true, message: 'Unit number is required' },
                    vehicleReg: { required: true, message: 'Registration is required' },
                    vehicleMake: { required: true, message: 'Make & model is required' },
                    vehicleOdometer: { 
                        pattern: /^\d*$/, 
                        message: 'Must be a number' 
                    }
                },

                setupValidation() {
                    Object.keys(this.rules).forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.addEventListener('blur', () => this.validateField(fieldId));
                            field.addEventListener('input', () => this.clearError(fieldId));
                        }
                    });
                },

                validateField(fieldId) {
                    const field = document.getElementById(fieldId);
                    const rule = this.rules[fieldId];
                    const value = field.value.trim();
                    const errorElement = document.getElementById(`error-${fieldId}`);

                    if (rule.required && !value) {
                        this.showError(fieldId, rule.message);
                        return false;
                    }

                    if (rule.pattern && value && !rule.pattern.test(value)) {
                        this.showError(fieldId, rule.message);
                        return false;
                    }

                    this.clearError(fieldId);
                    return true;
                },

                showError(fieldId, message) {
                    const field = document.getElementById(fieldId);
                    const errorElement = document.getElementById(`error-${fieldId}`);
                    
                    if (field) field.classList.add('error');
                    if (errorElement) {
                        errorElement.textContent = message;
                        errorElement.classList.add('active');
                    }
                },

                clearError(fieldId) {
                    const field = document.getElementById(fieldId);
                    const errorElement = document.getElementById(`error-${fieldId}`);
                    
                    if (field) field.classList.remove('error');
                    if (errorElement) errorElement.classList.remove('active');
                },

                validateAll() {
                    let isValid = true;
                    Object.keys(this.rules).forEach(fieldId => {
                        if (!this.validateField(fieldId)) {
                            isValid = false;
                        }
                    });
                    return isValid;
                },

                validateFormData(data) {
                    const errors = [];
                    
                    if (!data || typeof data !== 'object') {
                        return { valid: false, errors: ['Invalid data format'] };
                    }
                    
                    if (!data.studentFirstName) errors.push('First name is required');
                    if (!data.studentLastName) errors.push('Last name is required');
                    if (!data.candidateNumber || !/^\d{8}$/.test(data.candidateNumber)) {
                        errors.push('Candidate number must be 8 digits');
                    }
                    if (!data.jobDate) errors.push('Date is required');
                    if (!data.unitNumber) errors.push('Unit number is required');
                    if (!data.vehicleReg) errors.push('Vehicle registration is required');
                    if (!data.vehicleMake) errors.push('Vehicle make/model is required');
                    if (data.vehicleOdometer && !/^\d+$/.test(data.vehicleOdometer)) {
                        errors.push('Odometer must be a number');
                    }
                    
                    return {
                        valid: errors.length === 0,
                        errors: errors
                    };
                }
            },

            // ========================================================================
            // DATA COLLECTION MODULE
            // ========================================================================
            
            data: {
                collect() {
                    const firstName = document.getElementById('studentFirstName').value;
                    const lastName = document.getElementById('studentLastName').value;
                    const aggregatedTools = [];
                    
                    JobCardApp.state.jobs.forEach(job => 
                        job.tasks?.forEach(task => 
                            (task.toolsUsed || []).forEach(tool => aggregatedTools.push(tool))
                        )
                    );
                    
                    return {
                        id: 'current',
                        timestamp: new Date().toISOString(),
                        studentFirstName: firstName,
                        studentLastName: lastName,
                        studentName: `${firstName} ${lastName}`.trim(),
                        candidateNumber: document.getElementById('candidateNumber').value,
                        unitTitle: document.getElementById('unitTitle').value,
                        unitNumber: document.getElementById('unitNumber').value,
                        jobDate: document.getElementById('jobDate').value,
                        jobLocation: document.getElementById('jobLocation').value,
                        vehicleReg: document.getElementById('vehicleReg').value,
                        vehicleMake: document.getElementById('vehicleMake').value,
                        vehicleYear: document.getElementById('vehicleYear').value,
                        vehicleOdometer: document.getElementById('vehicleOdometer').value,
                        learnerProfile: document.getElementById('learnerProfile').value,
                        photos: JobCardApp.state.photos,
                        signature: JobCardApp.state.signatureImage,
                        customerRequests: JobCardApp.state.customerRequests,
                        jobs: JobCardApp.state.jobs,
                        tools: JobCardApp.state.tools,
                        aggregatedTools: aggregatedTools
                    };
                },

                populate(data) {
                    const legacyName = data.studentName || '';
                    let firstName = data.studentFirstName || '';
                    let lastName = data.studentLastName || '';
                    
                    if (!firstName && !lastName && legacyName) {
                        const parts = legacyName.split(' ');
                        firstName = parts.shift() || '';
                        lastName = parts.join(' ') || '';
                    }

                    document.getElementById('studentFirstName').value = firstName || '';
                    document.getElementById('studentLastName').value = lastName || '';
                    document.getElementById('candidateNumber').value = data.candidateNumber || '';
                    document.getElementById('unitTitle').value = data.unitTitle || '';
                    document.getElementById('unitNumber').value = data.unitNumber || '';
                    document.getElementById('jobDate').value = data.jobDate || '';
                    document.getElementById('jobLocation').value = data.jobLocation || '';
                    document.getElementById('vehicleReg').value = data.vehicleReg || '';
                    document.getElementById('vehicleMake').value = data.vehicleMake || '';
                    document.getElementById('vehicleYear').value = data.vehicleYear || '';
                    document.getElementById('vehicleOdometer').value = data.vehicleOdometer || '';
                    document.getElementById('learnerProfile').value = data.learnerProfile || '';
                    
                    JobCardApp.state.customerRequests = data.customerRequests || [];
                    JobCardApp.state.jobs = data.jobs || [];
                    JobCardApp.state.tools = data.tools || [];
                    JobCardApp.state.photos = data.photos || [];
                    JobCardApp.state.signatureImage = data.signature || null;
                    
                    JobCardApp.state.currentJobId = JobCardApp.state.jobs.length > 0 
                        ? Math.max(...JobCardApp.state.jobs.map(j => j.id)) : 0;
                    JobCardApp.state.currentTaskId = 0;
                    JobCardApp.state.currentToolId = JobCardApp.state.tools.length > 0 
                        ? Math.max(...JobCardApp.state.tools.map(t => t.id)) : 0;
                    
                    JobCardApp.state.jobs.forEach(job => {
                        if (job.collapsed === undefined) job.collapsed = false;
                        job.tasks = job.tasks || [];
                        job.tasks.forEach(task => {
                            if (task.id > JobCardApp.state.currentTaskId) {
                                JobCardApp.state.currentTaskId = task.id;
                            }
                            if (!Array.isArray(task.photos)) task.photos = [];
                            if (!Array.isArray(task.toolsUsed)) task.toolsUsed = [];
                            if (typeof task.technicalData !== 'string') {
                                task.technicalData = task.technicalData ? String(task.technicalData) : '';
                            }
                        });
                    });
                    
                    JobCardApp.requests.render();
                    JobCardApp.jobs.syncWithRequests();
                    JobCardApp.jobs.render();
                    JobCardApp.photos.display();
                    JobCardApp.ui.updateProgress();
                    JobCardApp.ui.updateExportChecklist();
                }
            },

            // ========================================================================
            // STORAGE MODULE
            // ========================================================================
            
            storage: {
                async save() {
                    JobCardApp.ui.showLoading(true);
                    try {
                        const data = JobCardApp.data.collect();
                        const validation = JobCardApp.validation.validateFormData(data);
                        
                        if (!validation.valid) {
                            JobCardApp.ui.showMessage('Please fix validation errors: ' + validation.errors.join(', '), 'error');
                            JobCardApp.ui.showLoading(false);
                            return;
                        }

                        const payload = JSON.stringify(data);
                        const approxBytes = new TextEncoder().encode(payload).length;
                        const maxBytes = 4 * 1024 * 1024; // 4MB safety limit for browser storage

                        if (approxBytes > maxBytes) {
                            JobCardApp.ui.showMessage('Save is too large (photos/attachments). Please export to PDF/JSON instead.', 'error');
                            JobCardApp.ui.showLoading(false);
                            return;
                        }
                        
                        if (JobCardApp.useLocalStorage) {
                            try {
                                localStorage.setItem(JobCardApp.config.STORAGE_KEY, payload);
                                JobCardApp.ui.showMessage('Job card saved', 'success');
                                JobCardApp.state.hasUnsavedChanges = false;
                                    JobCardApp.storageUsage.updateIndicator();
                            } catch (error) {
                                if (error.name === 'QuotaExceededError') {
                                    JobCardApp.ui.showMessage('Storage quota exceeded. Please export to backup.', 'error');
                                } else {
                                    JobCardApp.ui.showMessage('Error saving job card', 'error');
                                }
                            }
                        } else {
                            const transaction = JobCardApp.db.transaction([JobCardApp.config.STORE_NAME], 'readwrite');
                            const store = transaction.objectStore(JobCardApp.config.STORE_NAME);
                            const request = store.put(data);
                            
                            request.onerror = () => {
                                JobCardApp.ui.showMessage('Error saving job card', 'error');
                            };
                            
                            transaction.oncomplete = () => {
                                JobCardApp.ui.showMessage('Job card saved successfully!', 'success');
                                JobCardApp.state.hasUnsavedChanges = false;
                                    JobCardApp.storageUsage.updateIndicator();
                            };
                        }
                    } catch (error) {
                        console.error('Error in save:', error);
                        JobCardApp.ui.showMessage('Error saving job card', 'error');
                    } finally {
                        JobCardApp.ui.showLoading(false);
                    }
                },

                async load() {
                    JobCardApp.ui.showLoading(true);
                    try {
                        if (JobCardApp.useLocalStorage) {
                            const dataStr = localStorage.getItem(JobCardApp.config.STORAGE_KEY);
                            if (dataStr) {
                                const data = JSON.parse(dataStr);
                                const validation = JobCardApp.validation.validateFormData(data);
                                if (validation.valid) {
                                    JobCardApp.data.populate(data);
                                    JobCardApp.ui.showMessage('Job card loaded', 'success');
                                        JobCardApp.storageUsage.updateIndicator();
                                } else {
                                    JobCardApp.ui.showMessage('Saved data is invalid', 'error');
                                }
                            } else {
                                JobCardApp.ui.showMessage('No saved job card found', 'error');
                            }
                        } else {
                            const transaction = JobCardApp.db.transaction([JobCardApp.config.STORE_NAME], 'readonly');
                            const store = transaction.objectStore(JobCardApp.config.STORE_NAME);
                            const request = store.get('current');
                            
                            request.onsuccess = () => {
                                const data = request.result;
                                if (data) {
                                    const validation = JobCardApp.validation.validateFormData(data);
                                    if (validation.valid) {
                                        JobCardApp.data.populate(data);
                                        JobCardApp.ui.showMessage('Job card loaded!', 'success');
                                            JobCardApp.storageUsage.updateIndicator();
                                    } else {
                                        JobCardApp.ui.showMessage('Saved data is invalid', 'error');
                                    }
                                } else {
                                    JobCardApp.ui.showMessage('No saved job card found', 'error');
                                }
                            };
                            
                            request.onerror = () => {
                                JobCardApp.ui.showMessage('Error loading job card', 'error');
                            };
                        }
                    } catch (error) {
                        console.error('Error in load:', error);
                        JobCardApp.ui.showMessage('Error loading job card', 'error');
                    } finally {
                        JobCardApp.ui.showLoading(false);
                    }
                }
            },

            // ========================================================================
            // AUTO-SAVE MODULE
            // ========================================================================
            
            autoSave: {
                start() {
                    JobCardApp.autoSaveInterval = setInterval(() => {
                        if (JobCardApp.state.hasUnsavedChanges) {
                            this.save();
                        }
                    }, JobCardApp.config.AUTO_SAVE_INTERVAL);

                    window.addEventListener('beforeunload', () => {
                        clearInterval(JobCardApp.autoSaveInterval);
                    });
                },

                async save() {
                    try {
                        const data = JobCardApp.data.collect();
                        const validation = JobCardApp.validation.validateFormData(data);
                        
                        if (!validation.valid) return;

                        const payload = JSON.stringify(data);
                        const approxBytes = new TextEncoder().encode(payload).length;
                        const maxBytes = 4 * 1024 * 1024; // 4MB safety limit

                        if (approxBytes > maxBytes) {
                            // Skip auto-save when too large; user will be notified on manual save
                            return;
                        }
                        
                        if (JobCardApp.useLocalStorage) {
                            localStorage.setItem(JobCardApp.config.STORAGE_KEY, payload);
                        } else {
                            const transaction = JobCardApp.db.transaction([JobCardApp.config.STORE_NAME], 'readwrite');
                            const store = transaction.objectStore(JobCardApp.config.STORE_NAME);
                            store.put(data);
                        }
                        
                        JobCardApp.state.hasUnsavedChanges = false;
                            JobCardApp.storageUsage.updateIndicator();
                        this.showIndicator();
                    } catch (error) {
                        console.error('Auto-save error:', error);
                    }
                },

                showIndicator() {
                    const indicator = document.getElementById('autoSaveIndicator');
                    indicator.classList.add('active');
                    setTimeout(() => {
                        indicator.classList.remove('active');
                    }, 2000);
                }
                },

                // ========================================================================
                // STORAGE USAGE MODULE
                // ========================================================================
            
                storageUsage: {
                    getEstimatedSize() {
                        try {
                            const data = JobCardApp.data.collect();
                            const payload = JSON.stringify(data);
                            const bytes = new TextEncoder().encode(payload).length;
                            return bytes;
                        } catch (error) {
                            return 0;
                        }
                    },

                    formatBytes(bytes) {
                        if (bytes === 0) return '0 B';
                        const k = 1024;
                        const sizes = ['B', 'KB', 'MB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
                    },

                    updateIndicator() {
                        const indicator = document.getElementById('storageIndicator');
                        if (!indicator) return;

                        const usedBytes = this.getEstimatedSize();
                        const maxBytes = 4 * 1024 * 1024; // 4MB
                        const percentUsed = Math.round((usedBytes / maxBytes) * 100);
                        const formatted = this.formatBytes(usedBytes);

                        indicator.textContent = `Storage: ${formatted} (${percentUsed}%)`;
                    
                        // Update visual state
                        indicator.classList.remove('warning', 'critical');
                        if (percentUsed >= 90) {
                            indicator.classList.add('critical');
                        } else if (percentUsed >= 70) {
                            indicator.classList.add('warning');
                        }
                    }
            },

            // ========================================================================
            // REQUESTS MODULE
            // ========================================================================
            
            requests: {
                add() {
                    const input = document.getElementById('newRequestInput');
                    const text = input.value.trim();
                    
                    if (!text) {
                        JobCardApp.ui.showMessage('Please enter a customer request', 'error');
                        return;
                    }

                    const request = {
                        id: Date.now(),
                        text: text,
                        completed: false
                    };

                    JobCardApp.state.customerRequests.push(request);
                    JobCardApp.jobs.syncWithRequests();
                    input.value = '';
                    this.render();
                    JobCardApp.jobs.render();
                    JobCardApp.ui.updateProgress();
                    JobCardApp.ui.showMessage('Customer request added', 'success');
                    JobCardApp.ui.announceToScreenReader('Customer request added');
                    JobCardApp.state.hasUnsavedChanges = true;
                },

                toggle(id) {
                    const request = JobCardApp.state.customerRequests.find(r => r.id === id);
                    if (request) {
                        request.completed = !request.completed;
                        const job = JobCardApp.state.jobs.find(j => j.requestId === request.id);
                        if (job) job.completed = request.completed;
                        this.render();
                        JobCardApp.jobs.render();
                        JobCardApp.ui.updateProgress();
                        JobCardApp.state.hasUnsavedChanges = true;
                    }
                },

                delete(id) {
                    if (confirm('Delete this customer request and its reports?')) {
                        JobCardApp.state.customerRequests = JobCardApp.state.customerRequests.filter(r => r.id !== id);
                        JobCardApp.jobs.syncWithRequests();
                        this.render();
                        JobCardApp.jobs.render();
                        JobCardApp.ui.updateProgress();
                        JobCardApp.ui.showMessage('Customer request removed', 'success');
                        JobCardApp.state.hasUnsavedChanges = true;
                    }
                },

                render() {
                    const requestsList = document.getElementById('requestsList');
                    if (!requestsList) return; // No separate requests list UI anymore
                    
                    if (JobCardApp.state.customerRequests.length === 0) {
                        requestsList.innerHTML = '';
                        return;
                    }

                    // Keep rendering for potential future use; currently not displayed
                    requestsList.innerHTML = JobCardApp.state.customerRequests.map((req, index) => `
                        <div class="request-item ${req.completed ? 'completed' : ''}">
                            <div style="flex-shrink: 0; width: 32px; height: 32px; border-radius: 50%; background: ${req.completed ? '#111111' : '#555555'}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">
                                ${req.completed ? '‚úì' : index + 1}
                            </div>
                            <div class="request-text">${JobCardApp.utils.escapeHtml(req.text)}</div>
                            <button class="delete-btn" onclick="JobCardApp.requests.delete(${req.id})"
                                    aria-label="Delete request">Remove</button>
                        </div>
                    `).join('');
                }
            },

            // ========================================================================
            // JOBS MODULE
            // ========================================================================
            
            jobs: {
                syncWithRequests() {
                    JobCardApp.state.customerRequests.forEach(req => {
                        let job = JobCardApp.state.jobs.find(j => j.requestId === req.id);
                        if (!job) {
                            JobCardApp.state.jobs.push({
                                id: req.id,
                                requestId: req.id,
                                requestText: req.text,
                                tasks: [],
                                completed: req.completed || false,
                                collapsed: false
                            });
                        } else {
                            job.requestText = req.text;
                            job.completed = req.completed || false;
                        }
                    });

                    JobCardApp.state.jobs = JobCardApp.state.jobs.filter(job => 
                        JobCardApp.state.customerRequests.some(req => req.id === job.requestId)
                    );
                },

                toggle(jobId) {
                    const job = JobCardApp.state.jobs.find(j => j.id === jobId);
                    if (job) {
                        job.completed = !job.completed;
                        const request = JobCardApp.state.customerRequests.find(r => r.id === job.requestId);
                        if (request) request.completed = job.completed;
                        this.render();
                        JobCardApp.requests.render();
                        JobCardApp.ui.updateProgress();
                        JobCardApp.state.hasUnsavedChanges = true;
                    }
                },

                toggleCollapse(jobId) {
                    const job = JobCardApp.state.jobs.find(j => j.id === jobId);
                    if (job) {
                        job.collapsed = !job.collapsed;
                        const content = document.getElementById(`job-content-${jobId}`);
                        const icon = document.getElementById(`collapse-icon-${jobId}`);
                        if (content) {
                            if (job.collapsed) {
                                content.style.opacity = '0';
                                setTimeout(() => {
                                    content.style.display = 'none';
                                }, 200);
                            } else {
                                content.style.display = 'block';
                                setTimeout(() => {
                                    content.style.opacity = '1';
                                }, 10);
                            }
                        }
                        if (icon) {
                            icon.textContent = job.collapsed ? '‚ñ∂' : '‚ñº';
                        }
                        JobCardApp.state.hasUnsavedChanges = true;
                    }
                },

                addTask(jobId) {
                    const input = document.getElementById(`taskInput-${jobId}`);
                    const description = input.value.trim();
                    
                    if (!description) {
                        JobCardApp.ui.showMessage('Please describe the task', 'error');
                        return;
                    }

                    const job = JobCardApp.state.jobs.find(j => j.id === jobId);
                    if (!job) return;

                    const task = {
                        id: ++JobCardApp.state.currentTaskId,
                        description: description,
                        completed: false,
                        photos: [],
                        toolsUsed: [],
                        technicalData: '',
                        timeStarted: new Date().toISOString(),
                        timeCompleted: null,
                        duration: null
                    };

                    job.tasks.push(task);
                    input.value = '';
                    this.render();
                    JobCardApp.ui.updateProgress();
                    JobCardApp.ui.showMessage('Task added', 'success');
                    JobCardApp.state.hasUnsavedChanges = true;
                },

                async addTaskWithDetails(jobId) {
                    const descInput = document.getElementById(`taskInput-${jobId}`);
                    const toolsInput = document.getElementById(`taskTools-${jobId}`);
                    const technicalInput = document.getElementById(`taskTechnical-${jobId}`);
                    const photosInput = document.getElementById(`taskPhotos-${jobId}`);
                    
                    const description = descInput.value.trim();
                    
                    if (!description) {
                        JobCardApp.ui.showMessage('Please describe what you did', 'error');
                        return;
                    }

                    const job = JobCardApp.state.jobs.find(j => j.id === jobId);
                    if (!job) return;

                    JobCardApp.ui.showLoading(true);

                    try {
                        // Create the task
                        const task = {
                            id: ++JobCardApp.state.currentTaskId,
                            description: description,
                            completed: false,
                            photos: [],
                            toolsUsed: toolsInput.value.trim() ? toolsInput.value.split(',').map(t => t.trim()).filter(t => t) : [],
                            technicalData: technicalInput.value.trim(),
                            timeStarted: new Date().toISOString(),
                            timeCompleted: null,
                            duration: null
                        };

                        // Handle photo uploads if any
                        if (photosInput.files && photosInput.files.length > 0) {
                            const validFiles = Array.from(photosInput.files).filter(file => {
                                if (!JobCardApp.config.ALLOWED_IMAGE_TYPES.includes(file.type)) {
                                    JobCardApp.ui.showMessage(`${file.name} is not a supported image format`, 'error');
                                    return false;
                                }
                                if (file.size > JobCardApp.config.MAX_FILE_SIZE) {
                                    JobCardApp.ui.showMessage(`${file.name} is too large (max 10MB)`, 'error');
                                    return false;
                                }
                                return true;
                            });

                            for (const file of validFiles) {
                                const compressed = await JobCardApp.photos.compress(file);
                                task.photos.push({ 
                                    id: Date.now() + Math.random(), 
                                    dataUrl: compressed.dataUrl 
                                });
                            }
                        }

                        job.tasks.push(task);
                        
                        // Clear form
                        descInput.value = '';
                        toolsInput.value = '';
                        technicalInput.value = '';
                        photosInput.value = '';
                        
                        this.render();
                        JobCardApp.ui.updateProgress();
                        JobCardApp.ui.showMessage('Report saved successfully', 'success');
                        JobCardApp.state.hasUnsavedChanges = true;
                    } catch (error) {
                        console.error('Error adding task:', error);
                        JobCardApp.ui.showMessage('Error saving report', 'error');
                    } finally {
                        JobCardApp.ui.showLoading(false);
                    }
                },

                toggleTask(jobId, taskId) {
                    const job = JobCardApp.state.jobs.find(j => j.id === jobId);
                    if (!job) return;
                    
                    const task = job.tasks.find(t => t.id === taskId);
                    if (task) {
                        task.completed = !task.completed;
                        
                        if (task.completed) {
                            task.timeCompleted = new Date().toISOString();
                            const start = new Date(task.timeStarted);
                            const end = new Date(task.timeCompleted);
                            task.duration = Math.round((end - start) / 60000); // minutes
                        } else {
                            task.timeCompleted = null;
                            task.duration = null;
                        }
                        
                        this.render();
                        JobCardApp.ui.updateProgress();
                        JobCardApp.state.hasUnsavedChanges = true;
                    }
                },

                deleteTask(jobId, taskId) {
                    const job = JobCardApp.state.jobs.find(j => j.id === jobId);
                    if (!job) return;
                    
                    job.tasks = job.tasks.filter(t => t.id !== taskId);
                    this.render();
                    JobCardApp.ui.updateProgress();
                    JobCardApp.ui.showMessage('Task deleted', 'success');
                    JobCardApp.state.hasUnsavedChanges = true;
                },

                updateTaskTools(jobId, taskId, toolsString) {
                    const job = JobCardApp.state.jobs.find(j => j.id === jobId);
                    if (!job) return;
                    const task = job.tasks.find(t => t.id === taskId);
                    if (!task) return;
                    task.toolsUsed = toolsString.split(',').map(t => t.trim()).filter(t => t);
                    this.render();
                    JobCardApp.state.hasUnsavedChanges = true;
                },

                updateTaskTechnicalData(jobId, taskId, data) {
                    const job = JobCardApp.state.jobs.find(j => j.id === jobId);
                    if (!job) return;
                    const task = job.tasks.find(t => t.id === taskId);
                    if (!task) return;
                    task.technicalData = data;
                    this.render();
                    JobCardApp.state.hasUnsavedChanges = true;
                },

                async handleTaskPhotoUpload(jobId, taskId, files) {
                    JobCardApp.ui.showLoading(true);

                    try {
                        const job = JobCardApp.state.jobs.find(j => j.id === jobId);
                        if (!job) return;
                        
                        const task = job.tasks.find(t => t.id === taskId);
                        if (!task) return;

                        // Validate files
                        const validFiles = Array.from(files).filter(file => {
                            if (!JobCardApp.config.ALLOWED_IMAGE_TYPES.includes(file.type)) {
                                JobCardApp.ui.showMessage(`${file.name} is not a supported image format`, 'error');
                                return false;
                            }
                            if (file.size > JobCardApp.config.MAX_FILE_SIZE) {
                                JobCardApp.ui.showMessage(`${file.name} is too large (max 10MB)`, 'error');
                                return false;
                            }
                            return true;
                        });

                        if (validFiles.length === 0) {
                            JobCardApp.ui.showLoading(false);
                            return;
                        }

                        for (const file of validFiles) {
                            const compressed = await JobCardApp.photos.compress(file);
                            task.photos.push({ 
                                id: Date.now() + Math.random(), 
                                dataUrl: compressed.dataUrl 
                            });
                        }
                        
                        this.render();
                        JobCardApp.ui.showMessage('Photos uploaded', 'success');
                        JobCardApp.state.hasUnsavedChanges = true;
                    } catch (error) {
                        console.error('Error uploading photos:', error);
                        JobCardApp.ui.showMessage('Error uploading photos', 'error');
                    } finally {
                        JobCardApp.ui.showLoading(false);
                    }
                },

                removePhotoFromTask(jobId, taskId, photoIndex) {
                    const job = JobCardApp.state.jobs.find(j => j.id === jobId);
                    if (!job) return;
                    
                    const task = job.tasks.find(t => t.id === taskId);
                    if (!task || !task.photos[photoIndex]) return;

                    task.photos.splice(photoIndex, 1);
                    this.render();
                    JobCardApp.ui.showMessage('Photo removed', 'success');
                    JobCardApp.state.hasUnsavedChanges = true;
                },

                render() {
                    const jobsList = document.getElementById('jobsList');
                    
                    if (JobCardApp.state.jobs.length === 0) {
                        jobsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîß</div><p>No jobs started yet.</p></div>';
                        return;
                    }

                    jobsList.innerHTML = JobCardApp.state.jobs.map((job, jobIndex) => `
                        <div class="job-card">
                            <div class="job-header" onclick="JobCardApp.jobs.toggleCollapse(${job.id})" style="cursor: pointer; user-select: none;">
                                <div class="job-title">
                                    <div class="job-number">Request ${jobIndex + 1}</div>
                                    <div class="job-request">
                                        <span style="font-size: 18px; margin-right: 8px;" id="collapse-icon-${job.id}">${job.collapsed ? '‚ñ∂' : '‚ñº'}</span>
                                        üìã ${JobCardApp.utils.escapeHtml(job.requestText)}
                                    </div>
                                </div>
                                <div class="job-status ${job.completed ? 'completed' : 'in-progress'}">
                                    ${job.completed ? '‚úì COMPLETE' : '‚è≥ IN PROGRESS'}
                                    <div style="font-size: 12px; color: inherit; margin-top: 8px; font-weight: 500;">
                                        ${(job.tasks?.filter(t => t.completed).length || 0)}/${(job.tasks?.length || 0)} reports done
                                    </div>
                                </div>
                            </div>

                            <div id="job-content-${job.id}" style="display: ${job.collapsed ? 'none' : 'block'};">

                            <!-- New Report Form -->
                            <div style="background: #f5f5f5; padding: 18px; border-radius: 12px; border: 2px solid #111111; margin-bottom: 20px;">
                                <div style="font-size: 15px; font-weight: 700; color: #111111; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                    <span>üìù</span> Add New Report
                                </div>

                                <div style="margin-bottom: 14px;">
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: #3c3c43; margin-bottom: 6px;">
                                        What did you do?
                                    </label>
                                    <textarea id="taskInput-${job.id}" 
                                              placeholder="Describe the work you performed..." 
                                              style="width: 100%; padding: 12px 14px; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 14px; min-height: 80px; font-family: inherit; resize: vertical;"></textarea>
                                </div>
                                
                                <div style="margin-bottom: 14px;">
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: #3c3c43; margin-bottom: 6px;">
                                        üîß Tools Used
                                    </label>
                                    <input type="text" 
                                           id="taskTools-${job.id}"
                                           placeholder="e.g., Wrench, Socket set, Multimeter" 
                                           style="width: 100%; padding: 10px 12px; border: 1px solid #d1d1d6; border-radius: 8px; font-size: 13px;">
                                </div>

                                <div style="margin-bottom: 14px;">
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: #3c3c43; margin-bottom: 6px;">
                                        üìà Technical Data & Measurements
                                    </label>
                                    <textarea id="taskTechnical-${job.id}"
                                              placeholder="e.g., Torque: 85 Nm, Temperature: 45¬∞C, Pressure: 2.5 bar" 
                                              style="width: 100%; padding: 10px 12px; border: 1px solid #d1d1d6; border-radius: 8px; font-size: 13px; min-height: 70px; font-family: inherit; resize: vertical;"></textarea>
                                </div>

                                <div style="margin-bottom: 14px;">
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: #3c3c43; margin-bottom: 6px;">
                                        üì∏ Photos / Evidence
                                    </label>
                                    <input type="file" 
                                           id="taskPhotos-${job.id}"
                                           accept="image/*" 
                                           multiple
                                           style="width: 100%; padding: 10px 12px; border: 1px solid #d1d1d6; border-radius: 8px; font-size: 13px; background: white;">
                                </div>

                                <button class="btn btn-primary" onclick="JobCardApp.jobs.addTaskWithDetails(${job.id})" style="width: 100%; padding: 14px; font-size: 15px;">
                                    ‚úì Save Report
                                </button>
                            </div>

                            <!-- Existing Reports -->
                            <div>
                                ${job.tasks.length > 0 ? `
                                    <div style="font-size: 15px; font-weight: 700; color: #1c1c1e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                        <span>üìã</span> Saved Reports (${job.tasks.length})
                                    </div>
                                ` : ''}
                                ${job.tasks.length === 0 ? 
                                    '' :
                                    job.tasks.map((task, taskIndex) => {
                                        const timeInfo = task.duration 
                                            ? `Time taken: ${task.duration} minute${task.duration !== 1 ? 's' : ''}`
                                            : '';
                                        
                                        return `
                                            <div class="task-item ${task.completed ? 'completed' : ''}" style="margin-bottom: 14px;">
                                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                                    <div class="task-header" style="margin-bottom: 0;">
                                                        <input type="checkbox" ${task.completed ? 'checked' : ''} 
                                                               onchange="JobCardApp.jobs.toggleTask(${job.id}, ${task.id})"
                                                               aria-label="Mark task as ${task.completed ? 'incomplete' : 'complete'}">
                                                        <div style="flex: 1;">
                                                            <div class="task-description">${JobCardApp.utils.escapeHtml(task.description)}</div>
                                                            ${timeInfo ? `<div class="task-time-info">${timeInfo}</div>` : ''}
                                                        </div>
                                                    </div>
                                                    <button class="btn btn-danger btn-small" 
                                                            onclick="JobCardApp.jobs.deleteTask(${job.id}, ${task.id})"
                                                            style="margin-left: 10px;">
                                                        üóë
                                                    </button>
                                                </div>

                                                ${(task.toolsUsed && task.toolsUsed.length > 0) || task.technicalData || (task.photos && task.photos.length > 0) ? `
                                                    <div style="margin-left: 32px; background: white; padding: 14px; border-radius: 10px; border: 1px solid #E5E5EA;">
                                                        ${task.toolsUsed && task.toolsUsed.length > 0 ? `
                                                            <div style="margin-bottom: 10px;">
                                                                <div style="font-size: 12px; font-weight: 600; color: #8E8E93; margin-bottom: 4px;">üîß TOOLS USED</div>
                                                                <div style="font-size: 13px; color: #1c1c1e;">${task.toolsUsed.join(', ')}</div>
                                                            </div>
                                                        ` : ''}

                                                        ${task.technicalData ? `
                                                            <div style="margin-bottom: 10px;">
                                                                <div style="font-size: 12px; font-weight: 600; color: #8E8E93; margin-bottom: 4px;">üìà TECHNICAL DATA</div>
                                                                <div style="font-size: 13px; color: #1c1c1e; white-space: pre-wrap;">${task.technicalData}</div>
                                                            </div>
                                                        ` : ''}

                                                        ${task.photos && task.photos.length > 0 ? `
                                                            <div>
                                                                <div style="font-size: 12px; font-weight: 600; color: #8E8E93; margin-bottom: 8px;">üì∏ PHOTOS (${task.photos.length})</div>
                                                                <div class="photo-grid">
                                                                    ${task.photos.map((photo, photoIndex) => `
                                                                        <div class="photo-item">
                                                                            <img src="${photo.dataUrl}" alt="Task evidence" loading="lazy">
                                                                            <button class="delete-photo-btn" 
                                                                                    onclick="JobCardApp.jobs.removePhotoFromTask(${job.id}, ${task.id}, ${photoIndex})"
                                                                                    aria-label="Delete photo">√ó</button>
                                                                        </div>
                                                                    `).join('')}
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    }).join('')
                                }
                            </div>
                            </div>
                        </div>
                    `).join('');
                }
            },

            // ========================================================================
            // PHOTOS MODULE
            // ========================================================================
            
            photos: {
                setupDragDrop() {
                    // This would be called for the main photo section if you have one
                    // For now, task photos handle their own uploads
                },

                async compress(file) {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                let width = img.width;
                                let height = img.height;
                                
                                if (width > JobCardApp.config.IMAGE_MAX_WIDTH) {
                                    height = (height * JobCardApp.config.IMAGE_MAX_WIDTH) / width;
                                    width = JobCardApp.config.IMAGE_MAX_WIDTH;
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                resolve({
                                    dataUrl: canvas.toDataURL('image/jpeg', JobCardApp.config.IMAGE_QUALITY),
                                    fileName: file.name,
                                    timestamp: new Date().toISOString()
                                });
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    });
                },

                display() {
                    const gallery = document.getElementById('photoGallery');
                    if (!gallery) return;
                    
                    if (JobCardApp.state.photos.length === 0) {
                        gallery.innerHTML = '';
                        return;
                    }
                    
                    gallery.innerHTML = JobCardApp.state.photos.map((photo, index) => `
                        <div class="photo-container">
                            <img src="${photo.dataUrl}" alt="Photo ${index + 1}" loading="lazy">
                            <button type="button" class="remove-photo" 
                                    onclick="JobCardApp.photos.remove(${index})"
                                    aria-label="Remove photo">√ó</button>
                        </div>
                    `).join('');
                },

                remove(index) {
                    JobCardApp.state.photos.splice(index, 1);
                    this.display();
                    JobCardApp.ui.showMessage('Photo removed', 'success');
                    JobCardApp.state.hasUnsavedChanges = true;
                }
            },

            // ========================================================================
            // SIGNATURE MODULE
            // ========================================================================
            
            signature: {
                setup() {
                    const canvas = document.getElementById('signatureCanvas');
                    if (!canvas) return;

                    const ctx = canvas.getContext('2d');

                    // Mouse events
                    canvas.addEventListener('mousedown', (e) => {
                        JobCardApp.state.isDrawing = true;
                        [JobCardApp.state.lastX, JobCardApp.state.lastY] = [e.offsetX, e.offsetY];
                    });

                    canvas.addEventListener('mousemove', (e) => {
                        if (!JobCardApp.state.isDrawing) return;
                        ctx.strokeStyle = '#333';
                        ctx.lineWidth = 2;
                        ctx.lineCap = 'round';
                        ctx.lineJoin = 'round';
                        ctx.beginPath();
                        ctx.moveTo(JobCardApp.state.lastX, JobCardApp.state.lastY);
                        ctx.lineTo(e.offsetX, e.offsetY);
                        ctx.stroke();
                        [JobCardApp.state.lastX, JobCardApp.state.lastY] = [e.offsetX, e.offsetY];
                    });

                    canvas.addEventListener('mouseup', () => {
                        JobCardApp.state.isDrawing = false;
                    });

                    canvas.addEventListener('mouseleave', () => {
                        JobCardApp.state.isDrawing = false;
                    });

                    // Touch events
                    canvas.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        const touch = e.touches[0];
                        const rect = canvas.getBoundingClientRect();
                        JobCardApp.state.isDrawing = true;
                        [JobCardApp.state.lastX, JobCardApp.state.lastY] = [
                            touch.clientX - rect.left, 
                            touch.clientY - rect.top
                        ];
                    });

                    canvas.addEventListener('touchmove', (e) => {
                        e.preventDefault();
                        if (!JobCardApp.state.isDrawing) return;
                        const touch = e.touches[0];
                        const rect = canvas.getBoundingClientRect();
                        const x = touch.clientX - rect.left;
                        const y = touch.clientY - rect.top;
                        
                        ctx.strokeStyle = '#333';
                        ctx.lineWidth = 2;
                        ctx.lineCap = 'round';
                        ctx.lineJoin = 'round';
                        ctx.beginPath();
                        ctx.moveTo(JobCardApp.state.lastX, JobCardApp.state.lastY);
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        [JobCardApp.state.lastX, JobCardApp.state.lastY] = [x, y];
                    });

                    canvas.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        JobCardApp.state.isDrawing = false;
                    });
                },

                clear() {
                    const canvas = document.getElementById('signatureCanvas');
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    JobCardApp.state.signatureImage = null;
                    JobCardApp.ui.showMessage('Signature cleared', 'info');
                    JobCardApp.state.hasUnsavedChanges = true;
                },

                save() {
                    const canvas = document.getElementById('signatureCanvas');
                    if (!canvas) return;
                    const canvasData = canvas.toDataURL('image/png');
                    JobCardApp.state.signatureImage = canvasData;
                    JobCardApp.ui.showMessage('Signature saved', 'success');
                    JobCardApp.ui.updateProgress();
                    JobCardApp.state.hasUnsavedChanges = true;
                }
            },

            // ========================================================================
            // TEMPLATES MODULE
            // ========================================================================
            
            templates: {
                async load() {
                    try {
                        const templates = [
                            'json-templates/demo-cooling-systems-assessment.json',
                            'json-templates/demo-brake-systems.json'
                        ];
                        
                        const select = document.getElementById('templateSelect');
                        
                        for (const templatePath of templates) {
                            try {
                                const response = await fetch(templatePath);
                                if (response.ok) {
                                    const data = await response.json();
                                    const option = document.createElement('option');
                                    option.value = templatePath;
                                    option.textContent = data.templateName || templatePath.split('/').pop();
                                    select.appendChild(option);
                                }
                            } catch (err) {
                                console.warn(`Failed to load template: ${templatePath}`, err);
                            }
                        }

                        select.addEventListener('change', () => this.apply());
                    } catch (error) {
                        console.error('Error loading templates:', error);
                    }
                },

                async apply() {
                    const select = document.getElementById('templateSelect');
                    const templatePath = select.value;

                    if (!templatePath) {
                        if (JobCardApp.state.customerRequests.length > 0 || JobCardApp.state.tools.length > 0) {
                            if (confirm('Clear template data (customer requests and tools)?')) {
                                JobCardApp.state.customerRequests = [];
                                JobCardApp.state.tools = [];
                                JobCardApp.state.jobs = [];
                                JobCardApp.state.currentJobId = 0;
                                JobCardApp.state.currentTaskId = 0;
                                JobCardApp.state.currentToolId = 0;
                                
                                JobCardApp.requests.render();
                                JobCardApp.jobs.render();
                                JobCardApp.ui.showMessage('Template data cleared', 'info');
                                JobCardApp.state.hasUnsavedChanges = true;
                            }
                        }
                        return;
                    }

                    try {
                        JobCardApp.ui.showLoading(true);
                        const response = await fetch(templatePath);
                        const template = await response.json();

                        if (JobCardApp.state.customerRequests.length > 0 || JobCardApp.state.tools.length > 0) {
                            if (!confirm('Loading template will replace current customer requests and tools. Continue?')) {
                                select.value = '';
                                JobCardApp.ui.showLoading(false);
                                return;
                            }
                        }

                        JobCardApp.state.customerRequests = [];
                        if (template.customerRequests && Array.isArray(template.customerRequests)) {
                            template.customerRequests.forEach((item, index) => {
                                // Handle both string format and object format
                                if (typeof item === 'string') {
                                    JobCardApp.state.customerRequests.push({
                                        id: Date.now() + index,
                                        text: item,
                                        completed: false
                                    });
                                } else if (typeof item === 'object' && item.text) {
                                    JobCardApp.state.customerRequests.push({
                                        id: item.id || (Date.now() + index),
                                        text: item.text,
                                        completed: item.completed || false
                                    });
                                }
                            });
                        }

                        JobCardApp.state.tools = [];
                        JobCardApp.state.currentToolId = 0;
                        if (template.tools && Array.isArray(template.tools)) {
                            template.tools.forEach(item => {
                                // Handle both string format and object format
                                if (typeof item === 'string') {
                                    JobCardApp.state.tools.push({
                                        id: ++JobCardApp.state.currentToolId,
                                        name: item
                                    });
                                } else if (typeof item === 'object' && item.name) {
                                    JobCardApp.state.tools.push({
                                        id: ++JobCardApp.state.currentToolId,
                                        name: item.name
                                    });
                                }
                            });
                        }

                        JobCardApp.requests.render();
                        JobCardApp.jobs.syncWithRequests();
                        JobCardApp.jobs.render();
                        JobCardApp.ui.showMessage('Template loaded successfully!', 'success');
                        JobCardApp.state.hasUnsavedChanges = true;
                    } catch (error) {
                        console.error('Error loading template:', error);
                        JobCardApp.ui.showMessage('Error loading template', 'error');
                    } finally {
                        JobCardApp.ui.showLoading(false);
                    }
                },

                saveCurrentAsTemplate() {
                    const templateName = prompt('Enter template name:');
                    if (!templateName) return;
                    
                    const template = {
                        templateName: templateName,
                        customerRequests: JobCardApp.state.customerRequests.map(r => r.text),
                        tools: JobCardApp.state.tools.map(t => t.name),
                        description: 'Custom template created from current job card'
                    };
                    
                    const json = JSON.stringify(template, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `template-${templateName.toLowerCase().replace(/\s+/g, '-')}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    JobCardApp.ui.showMessage('Template saved', 'success');
                }
            },

            // ========================================================================
            // CARDS MODULE (Saved Cards Management)
            // ========================================================================
            
            cards: {
                async saveAsNew() {
                    const cardName = document.getElementById('cardName').value.trim();
                    
                    if (!cardName) {
                        JobCardApp.ui.showMessage('Please enter a name for this job card', 'error');
                        return;
                    }
                    
                    if (cardName.length > 100) {
                        JobCardApp.ui.showMessage('Card name too long (max 100 characters)', 'error');
                        return;
                    }

                    JobCardApp.ui.showLoading(true);
                    try {
                        const data = JobCardApp.data.collect();
                        const validation = JobCardApp.validation.validateFormData(data);
                        
                        if (!validation.valid) {
                            JobCardApp.ui.showMessage('Please fix validation errors before saving', 'error');
                            JobCardApp.ui.showLoading(false);
                            return;
                        }
                        
                        const cardId = Date.now().toString();
                        const cardData = {
                            id: cardId,
                            name: cardName,
                            timestamp: new Date().toISOString(),
                            data: data
                        };

                        if (JobCardApp.useLocalStorage) {
                            const savedCards = JSON.parse(localStorage.getItem('saved_cards') || '{}');
                            savedCards[cardId] = cardData;
                            localStorage.setItem('saved_cards', JSON.stringify(savedCards));
                            document.getElementById('cardName').value = '';
                            this.load();
                            JobCardApp.ui.showMessage(`Job card "${cardName}" saved!`, 'success');
                        } else {
                            const transaction = JobCardApp.db.transaction([JobCardApp.config.STORE_NAME], 'readwrite');
                            const store = transaction.objectStore(JobCardApp.config.STORE_NAME);
                            store.put(cardData);
                            
                            transaction.oncomplete = () => {
                                document.getElementById('cardName').value = '';
                                this.load();
                                JobCardApp.ui.showMessage(`Job card "${cardName}" saved!`, 'success');
                            };
                        }
                    } catch (error) {
                        console.error('Error saving card:', error);
                        JobCardApp.ui.showMessage('Error saving job card', 'error');
                    } finally {
                        JobCardApp.ui.showLoading(false);
                    }
                },

                search(searchTerm) {
                    this.load(searchTerm);
                },

                load(searchTerm = '') {
                    try {
                        const cardsList = document.getElementById('savedCardsList');
                        
                        if (JobCardApp.useLocalStorage) {
                            const savedCards = JSON.parse(localStorage.getItem('saved_cards') || '{}');
                            let allCards = Object.values(savedCards).filter(card => card.id && card.name);
                            
                            if (searchTerm) {
                                allCards = allCards.filter(card => 
                                    card.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    card.data?.vehicleReg?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    card.data?.candidateNumber?.includes(searchTerm)
                                );
                            }
                            
                            allCards.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                            
                            if (allCards.length === 0) {
                                cardsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìë</div><p>No saved job cards found</p></div>';
                                return;
                            }

                            cardsList.innerHTML = allCards.map(card => {
                                const date = new Date(card.timestamp).toLocaleDateString();
                                return `
                                    <div class="saved-card-item">
                                        <div class="card-info">
                                            <div class="card-name">${JobCardApp.utils.escapeHtml(card.name)}</div>
                                            <div class="card-date">Saved: ${date}</div>
                                        </div>
                                        <div class="card-actions">
                                            <button class="load-btn" onclick="JobCardApp.cards.loadCard('${card.id}')">Load</button>
                                            <button class="delete-card-btn" onclick="JobCardApp.cards.deleteCard('${card.id}')">Delete</button>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        } else {
                            const transaction = JobCardApp.db.transaction([JobCardApp.config.STORE_NAME], 'readonly');
                            const store = transaction.objectStore(JobCardApp.config.STORE_NAME);
                            const request = store.getAll();

                            request.onsuccess = () => {
                                let allCards = request.result.filter(card => card.id !== 'current' && card.name);
                                
                                if (searchTerm) {
                                    allCards = allCards.filter(card => 
                                        card.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                        card.data?.vehicleReg?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                        card.data?.candidateNumber?.includes(searchTerm)
                                    );
                                }
                                
                                allCards.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                                if (allCards.length === 0) {
                                    cardsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìë</div><p>No saved job cards found</p></div>';
                                    return;
                                }

                                cardsList.innerHTML = allCards.map(card => {
                                    const date = new Date(card.timestamp).toLocaleDateString();
                                    return `
                                        <div class="saved-card-item">
                                            <div class="card-info">
                                                <div class="card-name">${JobCardApp.utils.escapeHtml(card.name)}</div>
                                                <div class="card-date">Saved: ${date}</div>
                                            </div>
                                            <div class="card-actions">
                                                <button class="load-btn" onclick="JobCardApp.cards.loadCard('${card.id}')">Load</button>
                                                <button class="delete-card-btn" onclick="JobCardApp.cards.deleteCard('${card.id}')">Delete</button>
                                            </div>
                                        </div>
                                    `;
                                }).join('');
                            };
                        }
                    } catch (error) {
                        console.error('Error loading cards:', error);
                    }
                },

                loadCard(cardId) {
                    JobCardApp.ui.showLoading(true);
                    try {
                        if (JobCardApp.useLocalStorage) {
                            const savedCards = JSON.parse(localStorage.getItem('saved_cards') || '{}');
                            const cardData = savedCards[cardId];
                            
                            if (!cardData || !cardData.data) {
                                JobCardApp.ui.showMessage('Job card not found', 'error');
                                JobCardApp.ui.showLoading(false);
                                return;
                            }
                            
                            const validation = JobCardApp.validation.validateFormData(cardData.data);
                            if (!validation.valid) {
                                JobCardApp.ui.showMessage('Card data is invalid', 'error');
                                JobCardApp.ui.showLoading(false);
                                return;
                            }
                            
                            JobCardApp.data.populate(cardData.data);
                            JobCardApp.ui.showMessage(`Job card "${cardData.name}" loaded!`, 'success');
                            window.scrollTo(0, 0);
                            JobCardApp.ui.showLoading(false);
                        } else {
                            const transaction = JobCardApp.db.transaction([JobCardApp.config.STORE_NAME], 'readonly');
                            const store = transaction.objectStore(JobCardApp.config.STORE_NAME);
                            const request = store.get(cardId);

                            request.onsuccess = () => {
                                const card = request.result;
                                if (card && card.data) {
                                    const validation = JobCardApp.validation.validateFormData(card.data);
                                    if (!validation.valid) {
                                        JobCardApp.ui.showMessage('Card data is invalid', 'error');
                                        JobCardApp.ui.showLoading(false);
                                        return;
                                    }
                                    JobCardApp.data.populate(card.data);
                                    JobCardApp.ui.showMessage(`Job card "${card.name}" loaded!`, 'success');
                                    window.scrollTo(0, 0);
                                } else {
                                    JobCardApp.ui.showMessage('Job card not found', 'error');
                                }
                                JobCardApp.ui.showLoading(false);
                            };
                        }
                    } catch (error) {
                        console.error('Error loading card:', error);
                        JobCardApp.ui.showMessage('Error loading job card', 'error');
                        JobCardApp.ui.showLoading(false);
                    }
                },

                deleteCard(cardId) {
                    if (confirm('Delete this saved job card? This cannot be undone.')) {
                        JobCardApp.ui.showLoading(true);
                        try {
                            if (JobCardApp.useLocalStorage) {
                                const savedCards = JSON.parse(localStorage.getItem('saved_cards') || '{}');
                                delete savedCards[cardId];
                                localStorage.setItem('saved_cards', JSON.stringify(savedCards));
                                this.load();
                                JobCardApp.ui.showMessage('Job card deleted', 'success');
                                JobCardApp.ui.showLoading(false);
                            } else {
                                const transaction = JobCardApp.db.transaction([JobCardApp.config.STORE_NAME], 'readwrite');
                                const store = transaction.objectStore(JobCardApp.config.STORE_NAME);
                                store.delete(cardId);
                                
                                transaction.oncomplete = () => {
                                    this.load();
                                    JobCardApp.ui.showMessage('Job card deleted', 'success');
                                    JobCardApp.ui.showLoading(false);
                                };
                            }
                        } catch (error) {
                            console.error('Error deleting card:', error);
                            JobCardApp.ui.showMessage('Error deleting job card', 'error');
                            JobCardApp.ui.showLoading(false);
                        }
                    }
                }
            },

            // ========================================================================
            // EXPORTS MODULE
            // ========================================================================
            
            exports: {
                getJobStatus(job) {
                    if (!job || !Array.isArray(job.tasks) || job.tasks.length === 0) return 'In progress';
                    const allDone = job.tasks.every(t => t.completed);
                    return allDone ? 'Complete' : 'In progress';
                },

                getImageFormat(dataUrl) {
                    if (typeof dataUrl !== 'string') return 'JPEG';
                    if (dataUrl.startsWith('data:image/png')) return 'PNG';
                    if (dataUrl.startsWith('data:image/jpeg') || dataUrl.startsWith('data:image/jpg')) return 'JPEG';
                    // Fallback: jsPDF supports JPEG/PNG best
                    return 'JPEG';
                },

                toJSON() {
                    const data = JobCardApp.data.collect();
                    const json = JSON.stringify(data, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const filename = `JobCard_${data.candidateNumber || 'Export'}_${new Date().toISOString().split('T')[0]}.json`;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                    JobCardApp.ui.showMessage('JSON exported successfully', 'success');
                },

                importJSON() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = async (e) => {
                        try {
                            const file = e.target.files[0];
                            if (!file) return;
                            
                            const text = await file.text();
                            const data = JSON.parse(text);
                            const validation = JobCardApp.validation.validateFormData(data);
                            
                            if (validation.valid) {
                                JobCardApp.data.populate(data);
                                JobCardApp.ui.showMessage('JSON imported successfully', 'success');
                            } else {
                                JobCardApp.ui.showMessage('Invalid JSON file: ' + validation.errors.join(', '), 'error');
                            }
                        } catch (error) {
                            console.error('Error importing JSON:', error);
                            JobCardApp.ui.showMessage('Error importing JSON file', 'error');
                        }
                    };
                    input.click();
                },

                toPDF() {
                    JobCardApp.ui.showLoading(true);
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF('p', 'mm', 'a4');
                        const data = JobCardApp.data.collect();
                        const jobMap = Object.fromEntries((data.jobs || []).map(j => [j.requestId, j]));
                        const missing = this.getMissingItems(data);
                        
                        if (missing.length > 0) {
                            JobCardApp.ui.showMessage('Complete required fields before export: ' + missing.join(', '), 'error');
                            JobCardApp.ui.showLoading(false);
                            return;
                        }
                        
                        let yPos = 10;
                        const pageHeight = doc.internal.pageSize.getHeight();
                        const pageWidth = doc.internal.pageSize.getWidth();
                        const margin = 12;
                        const contentWidth = pageWidth - (margin * 2);
                        
                        // Header (black & white theme)
                        doc.setDrawColor(0);
                        doc.setLineWidth(0.3);
                        doc.rect(0, 0, pageWidth, 25);

                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(18);
                        doc.setFont(undefined, 'bold');
                        doc.text('MOTOR VEHICLE JOB CARD', pageWidth / 2, 14, { align: 'center' });

                        yPos = 30;
                        
                        const checkNewPage = (spaceNeeded = 20) => {
                            if (yPos + spaceNeeded > pageHeight - 10) {
                                doc.addPage();
                                yPos = 15;
                            }
                        };
                        
                        const sectionHeading = (title) => {
                            doc.setFontSize(11);
                            doc.setFont(undefined, 'bold');
                            doc.setFillColor(245, 245, 245);
                            doc.rect(margin, yPos - 2, contentWidth, 6, 'F');
                            doc.setTextColor(0, 0, 0);
                            doc.text(title, margin + 2, yPos + 2);
                            yPos += 8;
                            doc.setFontSize(9);
                            doc.setFont(undefined, 'normal');
                        };

                        // Student & Vehicle Information
                        sectionHeading('STUDENT & VEHICLE INFORMATION');
                        doc.autoTable({
                            startY: yPos,
                            margin: { left: margin, right: margin },
                            head: [['Field', 'Value']],
                            styles: { fontSize: 9, cellPadding: 3 },
                            body: [
                                ['First Name', data.studentFirstName || 'N/A'],
                                ['Last Name', data.studentLastName || 'N/A'],
                                ['Candidate Number', data.candidateNumber || 'N/A'],
                                ['Unit Title', data.unitTitle || 'N/A'],
                                ['Unit Number', data.unitNumber || 'N/A'],
                                ['Date', data.jobDate || 'N/A'],
                                ['Location / Workshop', data.jobLocation || 'N/A'],
                                ['Registration', data.vehicleReg || 'N/A'],
                                ['Make & Model', data.vehicleMake || 'N/A'],
                                ['Year', data.vehicleYear || 'N/A'],
                                ['Odometer', data.vehicleOdometer ? `${data.vehicleOdometer} miles` : 'N/A']
                            ]
                        });
                        yPos = doc.lastAutoTable.finalY + 6;
                        
                        // Customer Requests
                        if (data.customerRequests.length > 0) {
                            checkNewPage(25);
                            sectionHeading('CUSTOMER REQUESTS');
                            doc.autoTable({
                                startY: yPos,
                                margin: { left: margin, right: margin },
                                head: [['#', 'Request', 'Status']],
                                styles: { fontSize: 9, cellPadding: 3 },
                                body: data.customerRequests.map((req, idx) => [
                                    idx + 1,
                                    req.text,
                                    this.getJobStatus(jobMap[req.id])
                                ])
                            });
                            yPos = doc.lastAutoTable.finalY + 6;
                        }
                        
                        // Tools & Equipment
                        if (data.aggregatedTools && data.aggregatedTools.length > 0) {
                            checkNewPage(25);
                            sectionHeading('TOOLS & EQUIPMENT USED');
                            const uniqueTools = [...new Set(data.aggregatedTools)];
                            doc.autoTable({
                                startY: yPos,
                                margin: { left: margin, right: margin },
                                head: [['#', 'Tool']],
                                styles: { fontSize: 9, cellPadding: 3 },
                                body: uniqueTools.map((tool, idx) => [idx + 1, tool])
                            });
                            yPos = doc.lastAutoTable.finalY + 6;
                        }
                        
                        // Job Reports
                        if (data.jobs.length > 0) {
                            checkNewPage(30);
                            sectionHeading('JOB REPORTS');
                            
                            data.jobs.forEach((job, jobIdx) => {
                                doc.setFontSize(10);
                                doc.setFont(undefined, 'bold');
                                doc.text(`Request ${jobIdx + 1}: ${job.requestText || `Job ${jobIdx + 1}`}`, margin + 2, yPos);
                                yPos += 5;
                                
                                if (job.tasks && job.tasks.length > 0) {
                                    job.tasks.forEach((task, taskIdx) => {
                                        checkNewPage(20);
                                        doc.setFontSize(9);
                                        doc.setFont(undefined, 'normal');
                                        doc.text(`Task ${taskIdx + 1}: ${task.description}`, margin + 4, yPos);
                                        yPos += 4;
                                        
                                        const taskDetails = [];
                                        if (task.toolsUsed && task.toolsUsed.length) {
                                            taskDetails.push(['Tools Used', task.toolsUsed.join(', ')]);
                                        }
                                        if (task.technicalData) {
                                            taskDetails.push(['Technical Data', task.technicalData]);
                                        }
                                        if (task.duration) {
                                            taskDetails.push(['Time Taken', `${task.duration} minute${task.duration !== 1 ? 's' : ''}`]);
                                        }
                                        taskDetails.push(['Status', task.completed ? 'Complete' : 'In Progress']);
                                        
                                        if (taskDetails.length > 0) {
                                            doc.autoTable({
                                                startY: yPos,
                                                margin: { left: margin + 4, right: margin },
                                                head: [['Field', 'Details']],
                                                styles: { fontSize: 8, cellPadding: 2 },
                                                columnStyles: { 0: { cellWidth: 35 }, 1: { cellWidth: contentWidth - 39 } },
                                                body: taskDetails
                                            });
                                            yPos = doc.lastAutoTable.finalY + 4;
                                        }
                                    });
                                } else {
                                    doc.setFontSize(8);
                                    doc.text('No tasks recorded', margin + 4, yPos);
                                    yPos += 4;
                                }
                                yPos += 4;
                            });
                        }
                        
                        // Photos
                        const allPhotos = [...(data.photos || [])];
                        data.jobs.forEach(job => {
                            job.tasks?.forEach(task => {
                                if (task.photos && task.photos.length) {
                                    task.photos.forEach(p => allPhotos.push(p));
                                }
                            });
                        });

                        if (allPhotos.length > 0) {
                            checkNewPage(15);
                            sectionHeading('PHOTOGRAPHIC EVIDENCE');
                            const imgWidth = 45;
                            const imgHeight = 34;
                            const spacing = 6;
                            let xPos = margin;
                            let imgsInRow = 0;
                            const imgsPerRow = Math.max(1, Math.floor(contentWidth / (imgWidth + spacing)));

                            const ensureRowSpace = () => checkNewPage(imgHeight + 12);
                            ensureRowSpace();

                            allPhotos.forEach((photo) => {
                                if (imgsInRow >= imgsPerRow) {
                                    xPos = margin;
                                    yPos += imgHeight + spacing;
                                    imgsInRow = 0;
                                    ensureRowSpace();
                                }
                                try {
                                    const format = this.getImageFormat(photo.dataUrl);
                                    doc.addImage(photo.dataUrl, format, xPos, yPos, imgWidth, imgHeight);
                                    doc.setDrawColor(150);
                                    doc.rect(xPos, yPos, imgWidth, imgHeight);
                                } catch (err) {
                                    console.error('Error adding image:', err);
                                }
                                xPos += imgWidth + spacing;
                                imgsInRow++;
                            });
                            yPos += imgHeight + 8;
                        }
                        
                        // Signature & Reflection
                        checkNewPage(35);
                        sectionHeading('LEARNER SIGNATURE & REFLECTION');
                        
                        if (data.signature) {
                            try {
                                doc.addImage(data.signature, 'PNG', margin, yPos, 60, 25);
                                doc.setDrawColor(0);
                                doc.rect(margin, yPos, 60, 25);
                            } catch (err) {
                                console.error('Error adding signature:', err);
                                doc.text('Signature: ________________________', margin + 2, yPos + 15);
                            }
                        } else {
                            doc.setFontSize(9);
                            doc.text('Learner Signature: ________________________', margin + 2, yPos + 15);
                        }
                        yPos += 30;
                        
                        if (data.learnerProfile) {
                            checkNewPage(15);
                            doc.setFontSize(9);
                            doc.setFont(undefined, 'normal');
                            doc.text('Learner Reflection:', margin, yPos);
                            yPos += 5;

                            const reflectionLines = doc.splitTextToSize(data.learnerProfile, contentWidth - 4);
                            doc.setFontSize(8);
                            const lineHeight = 4;
                            reflectionLines.forEach((line) => {
                                checkNewPage(lineHeight + 4);
                                doc.text(line, margin + 2, yPos);
                                yPos += lineHeight;
                            });
                        }
                        
                        // Footer
                        const pageCount = doc.getNumberOfPages();
                        for (let i = 1; i <= pageCount; i++) {
                            doc.setPage(i);
                            doc.setFontSize(8);
                            doc.setTextColor(150);
                            doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 5, { align: 'center' });
                        }
                        
                        const filename = `JobCard_${data.unitNumber || 'U'}_${data.candidateNumber || 'C'}_${data.studentFirstName || ''}_${new Date().toISOString().split('T')[0]}.pdf`;
                        doc.save(filename);
                        JobCardApp.ui.showMessage('PDF exported successfully!', 'success');
                    } catch (error) {
                        console.error('Error exporting PDF:', error);
                        JobCardApp.ui.showMessage('Error exporting PDF', 'error');
                    } finally {
                        JobCardApp.ui.showLoading(false);
                    }
                },

                getMissingItems(data) {
                    const missing = [];
                    if (!data.studentFirstName) missing.push('First name');
                    if (!data.studentLastName) missing.push('Last name');
                    if (!data.candidateNumber) missing.push('Candidate number');
                    if (!data.unitNumber) missing.push('Unit number');
                    if (!data.jobDate) missing.push('Date');
                    if (!data.vehicleReg) missing.push('Vehicle registration');
                    if (!data.vehicleMake) missing.push('Vehicle make/model');
                    if (data.customerRequests.length === 0) missing.push('Customer requests');
                    if (data.jobs.length === 0) missing.push('Jobs');
                    return missing;
                }
            },

            // ========================================================================
            // UI MODULE
            // ========================================================================
            
            ui: {
                setDefaultDate() {
                    document.getElementById('jobDate').valueAsDate = new Date();
                },

                showMessage(message, type) {
                    const statusMessage = document.getElementById('statusMessage');
                    statusMessage.textContent = message;
                    statusMessage.className = `status-message ${type}`;
                    statusMessage.style.display = 'block';
                    setTimeout(() => {
                        statusMessage.style.display = 'none';
                    }, 5000);
                },

                showLoading(show) {
                    const loading = document.getElementById('loading');
                    if (show) {
                        loading.classList.add('active');
                    } else {
                        loading.classList.remove('active');
                    }
                },

                announceToScreenReader(message) {
                    const announcement = document.createElement('div');
                    announcement.setAttribute('role', 'status');
                    announcement.setAttribute('aria-live', 'polite');
                    announcement.className = 'sr-only';
                    announcement.textContent = message;
                    document.body.appendChild(announcement);
                    setTimeout(() => announcement.remove(), 1000);
                },

                initTabs() {
                    const tabs = document.querySelectorAll('.tabs .tab[data-tab-target]');
                    const mobileMenuTabs = document.querySelectorAll('.mobile-menu .tab[data-tab-target]');
                    const allTabs = [...tabs, ...mobileMenuTabs];
                    const panels = document.querySelectorAll('.section[data-tab]');
                    const hamburgerBtn = document.getElementById('hamburgerBtn');
                    const mobileMenu = document.getElementById('mobileMenu');
                    const mobileMenuClose = document.getElementById('mobileMenuClose');

                    const closeMobileMenu = () => {
                        mobileMenu.classList.remove('active');
                    };

                    const activate = (tabName) => {
                        allTabs.forEach(btn => btn.classList.toggle('active', btn.dataset.tabTarget === tabName));
                        panels.forEach(p => p.classList.toggle('active', p.dataset.tab === tabName));
                        
                        if (tabName === 'actions') {
                            this.updateVehicleSummary();
                            this.updateProgress();
                        }
                        
                        closeMobileMenu();
                        
                        try { 
                            localStorage.setItem('activeTab', tabName); 
                        } catch {}
                    };

                    this.navigateTab = (direction) => {
                        const activePanel = Array.from(panels).find(p => p.classList.contains('active'));
                        const current = activePanel ? activePanel.dataset.tab : 'template';
                        const idx = JobCardApp.config.TAB_SEQUENCE.indexOf(current);
                        const nextIdx = Math.min(JobCardApp.config.TAB_SEQUENCE.length - 1, Math.max(0, idx + direction));
                        const nextTabName = JobCardApp.config.TAB_SEQUENCE[nextIdx];
                        activate(nextTabName);
                    };

                    allTabs.forEach(btn => btn.addEventListener('click', () => activate(btn.dataset.tabTarget)));
                    hamburgerBtn.addEventListener('click', () => mobileMenu.classList.toggle('active'));
                    mobileMenuClose.addEventListener('click', closeMobileMenu);
                    mobileMenu.addEventListener('click', (e) => {
                        if (e.target === mobileMenu) closeMobileMenu();
                    });

                    let initial = 'template';
                    try {
                        const saved = localStorage.getItem('activeTab');
                        if (saved) initial = saved;
                    } catch {}
                    activate(initial);
                },

                navigateTab(direction) {
                    // This function is defined in initTabs
                },

                updateProgress() {
                    const data = JobCardApp.data.collect();
                    const required = [
                        'studentFirstName',
                        'studentLastName',
                        'candidateNumber',
                        'unitNumber',
                        'jobDate',
                        'vehicleReg',
                        'vehicleMake'
                    ];
                    
                    const completed = required.filter(field => data[field]).length;
                    const hasRequests = data.customerRequests.length > 0;
                    const hasJobs = data.jobs.length > 0;
                    const hasSignature = !!data.signature;
                    
                    const total = required.length + 3;
                    const current = completed + (hasRequests ? 1 : 0) + (hasJobs ? 1 : 0) + (hasSignature ? 1 : 0);
                    const progress = Math.round((current / total) * 100);
                    
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${progress}% Complete`;
                    
                    this.updateCompletionStatus();
                    this.updateExportChecklist();
                },

                updateCompletionStatus() {
                    const completedRequests = JobCardApp.state.customerRequests.filter(r => r.completed).length;
                    const totalRequests = JobCardApp.state.customerRequests.length;
                    
                    const completedTasks = JobCardApp.state.jobs.reduce((sum, job) => {
                        return sum + (job.tasks ? job.tasks.filter(t => t.completed).length : 0);
                    }, 0);
                    const totalTasks = JobCardApp.state.jobs.reduce((sum, job) => {
                        return sum + (job.tasks ? job.tasks.length : 0);
                    }, 0);

                    document.getElementById('completionRequests').textContent = `${completedRequests}/${totalRequests}`;
                    document.getElementById('completionTasks').textContent = `${completedTasks}/${totalTasks}`;
                },

                updateVehicleSummary() {
                    document.getElementById('summaryVehicleReg').textContent = document.getElementById('vehicleReg').value || '--';
                    document.getElementById('summaryVehicleMake').textContent = document.getElementById('vehicleMake').value || '--';
                    document.getElementById('summaryVehicleYear').textContent = document.getElementById('vehicleYear').value || '--';
                    document.getElementById('summaryVehicleOdometer').textContent = document.getElementById('vehicleOdometer').value || '--';
                },

                updateExportChecklist() {
                    const data = JobCardApp.data.collect();
                    const missing = JobCardApp.exports.getMissingItems(data);
                    const body = document.getElementById('exportChecklistBody');
                    const checklist = document.getElementById('exportChecklist');
                    const exportBtn = document.getElementById('exportBtnMain');
                    
                    if (!body || !checklist || !exportBtn) return;

                    if (missing.length === 0) {
                            body.innerHTML = '<div style="color: #111111; font-weight: 600;">‚úì Ready to export. All key details are present.</div>';
                            checklist.style.background = '#f5f5f5';
                            checklist.style.borderLeft = '4px solid #111111';
                        exportBtn.disabled = false;
                    } else {
                            body.innerHTML = '<div style="color: #111111; font-weight: 600;">Add before exporting:</div><ul style="margin: 6px 0 0 16px; color: #111111;">' + missing.map(item => `<li>${item}</li>`).join('') + '</ul>';
                            checklist.style.background = '#f5f5f5';
                            checklist.style.borderLeft = '4px solid #111111';
                        exportBtn.disabled = true;
                    }
                },

                trackChanges() {
                    document.querySelectorAll('input, textarea, select').forEach(element => {
                        element.addEventListener('change', () => {
                            JobCardApp.state.hasUnsavedChanges = true;
                        });
                    });

                    window.addEventListener('beforeunload', (e) => {
                        if (JobCardApp.state.hasUnsavedChanges) {
                            e.preventDefault();
                            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                        }
                    });
                },

                clearForm() {
                    if (confirm('Clear all data? This cannot be undone.')) {
                        JobCardApp.ui.showLoading(true);
                        
                        document.getElementById('studentFirstName').value = '';
                        document.getElementById('studentLastName').value = '';
                        document.getElementById('candidateNumber').value = '';
                        document.getElementById('unitTitle').value = '';
                        document.getElementById('unitNumber').value = '';
                        document.getElementById('jobDate').value = '';
                        document.getElementById('jobLocation').value = '';
                        document.getElementById('vehicleReg').value = '';
                        document.getElementById('vehicleMake').value = '';
                        document.getElementById('vehicleYear').value = '';
                        document.getElementById('vehicleOdometer').value = '';
                        document.getElementById('learnerProfile').value = '';
                        document.getElementById('templateSelect').value = '';
                        
                        JobCardApp.state.photos = [];
                        JobCardApp.state.signatureImage = null;
                        JobCardApp.state.customerRequests = [];
                        JobCardApp.state.jobs = [];
                        JobCardApp.state.tools = [];
                        JobCardApp.state.currentJobId = 0;
                        JobCardApp.state.currentTaskId = 0;
                        JobCardApp.state.currentToolId = 0;
                        
                        JobCardApp.signature.clear();
                        JobCardApp.requests.render();
                        JobCardApp.jobs.render();
                        JobCardApp.photos.display();
                        JobCardApp.ui.updateProgress();
                        
                        if (JobCardApp.useLocalStorage) {
                            localStorage.removeItem(JobCardApp.config.STORAGE_KEY);
                        } else {
                            const transaction = JobCardApp.db.transaction([JobCardApp.config.STORE_NAME], 'readwrite');
                            const store = transaction.objectStore(JobCardApp.config.STORE_NAME);
                            store.delete('current');
                        }
                        
                        JobCardApp.ui.showMessage('All data cleared', 'success');
                        JobCardApp.state.hasUnsavedChanges = false;
                        JobCardApp.ui.showLoading(false);
                    }
                }
            },

            // ========================================================================
            // KEYBOARD SHORTCUTS MODULE
            // ========================================================================
            
            keyboard: {
                setup() {
                    document.addEventListener('keydown', (e) => {
                        // Ctrl/Cmd + S to save
                        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                            e.preventDefault();
                            JobCardApp.storage.save();
                        }
                        
                        // Ctrl/Cmd + E to export
                        if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                            e.preventDefault();
                            JobCardApp.exports.toPDF();
                        }
                        
                        // Ctrl/Cmd + Arrow keys for tab navigation
                        if (e.ctrlKey || e.metaKey) {
                            if (e.key === 'ArrowRight') {
                                e.preventDefault();
                                JobCardApp.ui.navigateTab(1);
                            } else if (e.key === 'ArrowLeft') {
                                e.preventDefault();
                                JobCardApp.ui.navigateTab(-1);
                            }
                        }
                    });
                }
            },

            // ========================================================================
            // UTILITIES MODULE
            // ========================================================================
            
            utils: {
                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                },

                debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }
            }
        };

        // ========================================================================
        // INITIALIZE APPLICATION
        // ========================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            JobCardApp.init();
        });
    </script>
</body>
</html>